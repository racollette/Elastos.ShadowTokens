import { Asset, RenContract, RenTokens, } from "@renproject/interfaces";
import BigNumber from "bignumber.js";
import { keccak256 } from "ethereumjs-util";
import { sha3 } from "web3-utils";
import { Ox, randomBytes, strip0x, toBase64, unzip } from "./common";
import { rawEncode } from "./ethereumUtils";
// export const generateNHash = (tx: Tx): string => {
//     const encoded = rawEncode(
//         ["bytes32", "bytes32"],
//         [Ox(tx.hash), Ox(tx.args.n)],
//     );
//     return Ox(keccak256(encoded));
// };
/**
 * Hash the payloads associated with a RenVM cross-chain transaction.
 *
 * @param zip An array (or spread) of parameters with with types defined.
 */
export const generatePHash = (zip, logger) => {
    // Check if they called as hashPayload([...]) instead of hashPayload(...)
    const args = Array.isArray(zip[0]) ? zip[0] : zip; // tslint:disable-line: no-any
    const [types, values] = unzip(args);
    const message = rawEncode(types, values);
    const digest = Ox(keccak256(message));
    if (logger)
        logger.debug(`pHash: ${digest}: keccak256(${message.toString("hex")})`);
    return digest; // sha3 can accept a Buffer
};
const renContractRegex = /^(.*)0(.*)2(.*)$/;
const defaultMatch = [undefined, undefined, undefined, undefined];
/**
 * parseRenContract splits a RenVM contract (e.g. `BTC0Eth2Btc`) into the asset
 * (`BTC`), the origin chain (`Eth`) and the target chain (`Btc`).
 */
export const parseRenContract = (renContract) => {
    // re.exec("BTC0Eth2Btc") => ['BTC0Eth2Btc', 'BTC', 'Eth', 'Btc']
    const [, asset, from, to] = renContractRegex.exec(renContract) || defaultMatch;
    if (!asset || !from || !to) {
        throw new Error(`Invalid Ren Contract "${renContract}"`);
    }
    return {
        asset: asset,
        from: from,
        to: to
    };
};
export const getTokenName = (tokenOrContract) => {
    switch (tokenOrContract) {
        case RenTokens.BTC:
        case RenTokens.ZEC:
        case RenTokens.BCH: return tokenOrContract;
        case Asset.BTC:
        case "BTC": return RenTokens.BTC;
        case Asset.ZEC:
        case "ZEC": return RenTokens.ZEC;
        case Asset.BCH:
        case "BCH": return RenTokens.BCH;
        case Asset.ETH: throw new Error(`Unexpected token ${tokenOrContract}`);
        default:
            return getTokenName(parseRenContract(tokenOrContract).asset);
    }
};
export const syncGetTokenAddress = (renContract, network) => {
    switch (parseRenContract(renContract).asset) {
        case Asset.BTC:
            return network.addresses.gateways.RenBTC._address;
        case Asset.ZEC:
            return network.addresses.gateways.RenZEC._address;
        case Asset.BCH:
            return network.addresses.gateways.RenBCH._address;
        default:
            throw new Error(`Invalid Ren Contract ${renContract}`);
    }
};
export const generateGHash = (payload, /* amount: number | string, */ to, renContract, nonce, network, logger) => {
    const token = syncGetTokenAddress(renContract, network);
    const pHash = generatePHash(payload, logger);
    const encoded = rawEncode(["bytes32", /*"uint256",*/ "address", "address", "bytes32"], [Ox(pHash), /*amount,*/ Ox(token), Ox(to), Ox(nonce)]);
    const digest = Ox(keccak256(encoded));
    if (logger)
        logger.debug(`gHash: ${digest}: keccak256(${encoded.toString("hex")})`);
    return digest;
};
export const generateSighash = (pHash, amount, to, renContract, nonceHash, network, logger) => {
    const token = syncGetTokenAddress(renContract, network);
    const encoded = rawEncode(["bytes32", "uint256", "address", "address", "bytes32"], [Ox(pHash), amount, token, to, nonceHash]);
    const digest = Ox(keccak256(encoded));
    if (logger)
        logger.debug(`sigHash: ${digest}: keccak256(${encoded.toString("hex")})`);
    return digest;
};
export const txHashToBase64 = (txHash) => {
    if (Buffer.isBuffer(txHash)) {
        return txHash.toString("base64");
    }
    // Check if it's hex-encoded
    if (txHash.match(/^(0x)?[0-9a-fA-Z]{64}$/)) {
        return Buffer.from(strip0x(txHash), "hex").toString("base64");
    }
    return txHash;
};
export const generateMintTxHash = (renContract, encodedID, utxo, logger) => {
    const message = `txHash_${renContract}_${encodedID}_${toBase64(utxo.txHash)}_${utxo.vOut}`;
    const digest = txHashToBase64(keccak256(Buffer.from(message)));
    if (logger)
        logger.debug(`Mint txHash: ${digest}: keccak256(${message})`);
    return digest;
};
export const generateBurnTxHash = (renContract, encodedID, logger) => {
    const message = `txHash_${renContract}_${encodedID}`;
    const digest = txHashToBase64(keccak256(Buffer.from(message)));
    if (logger)
        logger.debug(`[RenJS] Burn txHash: ${digest}: keccak256(${message})`);
    return digest;
};
export const signatureToString = (sig) => Ox(`${strip0x(sig.r)}${sig.s}${sig.v.toString(16)}`);
const switchV = (v) => v === 27 ? 28 : 27; // 28 - (v - 27);
const secp256k1n = new BigNumber("FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141", 16);
export const fixSignature = (response, network, logger) => {
    if (!response.out) {
        throw new Error(`Expected transaction response to have signature`);
    }
    const expectedSighash = generateSighash(response.autogen.phash, response.autogen.amount, response.in.to, response.to, response.autogen.nhash, network, logger);
    if (Ox(response.autogen.sighash) !== Ox(expectedSighash)) {
        if (logger)
            logger.warn(`Warning: RenVM returned invalid signature hash. Expected ${expectedSighash} but for ${response.autogen.sighash}`);
    }
    const r = response.out.r;
    let s = new BigNumber(strip0x(response.out.s), 16);
    let v = ((new BigNumber(strip0x(response.out.v) || "0", 16).toNumber() + 27) || 27);
    // For a given key, there are two valid signatures for each signed message.
    // We always take the one with the lower `s`.
    // secp256k1n/2 = 57896044618658097711785492504343953926418782139537452191302581570759080747168.5
    if (s.gt(secp256k1n.div(2))) {
        // Take s = -s % secp256k1n
        s = secp256k1n.minus(s);
        // Switch v
        v = switchV(v);
    }
    // TODO: Fix code below to check against proper mintAuthority
    // // Currently, the wrong `v` value may be returned from RenVM. We recover the
    // // address to see if we need to switch `v`. This can be removed once RenVM
    // // has been updated.
    // const recovered = {
    //     [v]: pubToAddress(ecrecover(
    //         Buffer.from(strip0x(response.autogen.sighash), "hex"),
    //         v,
    //         Buffer.from(strip0x(r), "hex"),
    //         s.toArrayLike(Buffer, "be", 32),
    //     )),
    //     [switchV(v)]: pubToAddress(ecrecover(
    //         Buffer.from(strip0x(response.autogen.sighash), "hex"),
    //         switchV(v),
    //         Buffer.from(strip0x(r), "hex"),
    //         s.toArrayLike(Buffer, "be", 32),
    //     )),
    // };
    // const expected = Buffer.from(strip0x(.network.renVM.mintAuthority), "hex");
    // if (recovered[v].equals(expected)) {
    //     // Do nothing
    // } else if (recovered[switchV(v)].equals(expected)) {
    //     // tslint:disable-next-line: no-console
    //     console.info("[info][ren-js] switching v value");
    //     v = switchV(v);
    // } else {
    //     throw new Error(`Invalid signature - unable to recover mint authority from signature (Expected ${Ox(expected)}, got ${Ox(recovered[v])})`);
    // }
    const to32Bytes = (bn) => ("0".repeat(64) + bn.toString(16)).slice(-64);
    const signature = {
        r,
        s: to32Bytes(s),
        v,
    };
    return signature;
};
export const getTokenAddress = async (network, web3, tokenOrContract) => {
    try {
        const registry = new web3.eth.Contract(network.addresses.gateways.GatewayRegistry.abi, network.addresses.gateways.GatewayRegistry.address);
        return await registry.methods.getTokenBySymbol(getTokenName(tokenOrContract)).call();
    }
    catch (error) {
        (error || {}).error = `Error looking up ${tokenOrContract} token address: ${error.message}`;
        throw error;
    }
};
export const getGatewayAddress = async (network, web3, tokenOrContract) => {
    try {
        const registry = new web3.eth.Contract(network.addresses.gateways.GatewayRegistry.abi, network.addresses.gateways.GatewayRegistry.address);
        return await registry.methods.getGatewayBySymbol(getTokenName(tokenOrContract)).call();
    }
    catch (error) {
        (error || {}).error = `Error looking up ${tokenOrContract}Gateway address: ${error.message}`;
        throw error;
    }
};
export const findTransactionBySigHash = async (network, web3, tokenOrContract, sigHash, logger) => {
    try {
        const gatewayAddress = await getGatewayAddress(network, web3, tokenOrContract);
        const gatewayContract = new web3.eth.Contract(network.addresses.gateways.BTCGateway.abi, gatewayAddress);
        // We can skip the `status` check and call `getPastLogs` directly - for now both are called in case
        // the contract
        const status = await gatewayContract.methods.status(sigHash).call();
        if (status) {
            const recentRegistrationEvents = await web3.eth.getPastLogs({
                address: gatewayAddress,
                fromBlock: "1",
                toBlock: "latest",
                // topics: [sha3("LogDarknodeRegistered(address,uint256)"), "0x000000000000000000000000" +
                // address.slice(2), null, null] as any,
                topics: [sha3("LogMint(address,uint256,uint256,bytes32)"), null, null, sigHash],
            });
            if (!recentRegistrationEvents.length) {
                throw new Error(`Mint has been submitted but no log was found.`);
            }
            const log = recentRegistrationEvents[0];
            return log.transactionHash;
        }
    }
    catch (error) {
        // tslint:disable-next-line: no-console
        if (logger)
            logger.error(error);
        // Continue with transaction
    }
    return;
};
/**
 * Returns a random 32 byte hex string (prefixed with '0x').
 */
export const randomNonce = () => randomBytes(32);
export const resolveInToken = (sendToken) => {
    switch (sendToken) {
        case "BTC":
            return RenContract.Btc2Eth;
        case "BCH":
            return RenContract.Bch2Eth;
        case "ZEC":
            return RenContract.Zec2Eth;
        default:
            return sendToken;
    }
};
export const resolveOutToken = (sendToken) => {
    switch (sendToken) {
        case "BTC":
            return RenContract.Eth2Btc;
        case "BCH":
            return RenContract.Eth2Bch;
        case "ZEC":
            return RenContract.Eth2Zec;
        default:
            return sendToken;
    }
};
export const resolveSendTo = ({ isMint }) => (params) => {
    params.sendToken = isMint ? resolveInToken(params.sendToken) : resolveOutToken(params.sendToken);
    return params;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuVk1VdGlscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZW5WTVV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDSCxLQUFLLEVBQW1FLFdBQVcsRUFBRSxTQUFTLEdBRWpHLE1BQU0sd0JBQXdCLENBQUM7QUFDaEMsT0FBTyxTQUFTLE1BQU0sY0FBYyxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUU1QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBRWxDLE9BQU8sRUFBUSxFQUFFLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQzNFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUU1QyxxREFBcUQ7QUFDckQsaUNBQWlDO0FBQ2pDLGtDQUFrQztBQUNsQyx3Q0FBd0M7QUFDeEMsU0FBUztBQUVULHFDQUFxQztBQUNyQyxLQUFLO0FBRUw7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxDQUFDLEdBQVksRUFBRSxNQUFlLEVBQVUsRUFBRTtJQUNuRSx5RUFBeUU7SUFDekUsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBbUIsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsOEJBQThCO0lBRW5HLE1BQU0sQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXBDLE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDekMsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMs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