{"ast":null,"code":"/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n\n/* eslint-env node */\n'use strict';\n\nvar utils = require('../utils.js');\n\nvar logging = utils.log;\n/* iterates the stats graph recursively. */\n\nfunction walkStats(stats, base, resultSet) {\n  if (!base || resultSet.has(base.id)) {\n    return;\n  }\n\n  resultSet.set(base.id, base);\n  Object.keys(base).forEach(function (name) {\n    if (name.endsWith('Id')) {\n      walkStats(stats, stats.get(base[name]), resultSet);\n    } else if (name.endsWith('Ids')) {\n      base[name].forEach(function (id) {\n        walkStats(stats, stats.get(id), resultSet);\n      });\n    }\n  });\n}\n/* filter getStats for a sender/receiver track. */\n\n\nfunction filterStats(result, track, outbound) {\n  var streamStatsType = outbound ? 'outbound-rtp' : 'inbound-rtp';\n  var filteredResult = new Map();\n\n  if (track === null) {\n    return filteredResult;\n  }\n\n  var trackStats = [];\n  result.forEach(function (value) {\n    if (value.type === 'track' && value.trackIdentifier === track.id) {\n      trackStats.push(value);\n    }\n  });\n  trackStats.forEach(function (trackStat) {\n    result.forEach(function (stats) {\n      if (stats.type === streamStatsType && stats.trackId === trackStat.id) {\n        walkStats(result, stats, filteredResult);\n      }\n    });\n  });\n  return filteredResult;\n}\n\nmodule.exports = {\n  shimGetUserMedia: require('./getusermedia'),\n  shimMediaStream: function (window) {\n    window.MediaStream = window.MediaStream || window.webkitMediaStream;\n  },\n  shimOnTrack: function (window) {\n    if (typeof window === 'object' && window.RTCPeerConnection && !('ontrack' in window.RTCPeerConnection.prototype)) {\n      Object.defineProperty(window.RTCPeerConnection.prototype, 'ontrack', {\n        get: function () {\n          return this._ontrack;\n        },\n        set: function (f) {\n          if (this._ontrack) {\n            this.removeEventListener('track', this._ontrack);\n          }\n\n          this.addEventListener('track', this._ontrack = f);\n        },\n        enumerable: true,\n        configurable: true\n      });\n      var origSetRemoteDescription = window.RTCPeerConnection.prototype.setRemoteDescription;\n\n      window.RTCPeerConnection.prototype.setRemoteDescription = function () {\n        var pc = this;\n\n        if (!pc._ontrackpoly) {\n          pc._ontrackpoly = function (e) {\n            // onaddstream does not fire when a track is added to an existing\n            // stream. But stream.onaddtrack is implemented so we use that.\n            e.stream.addEventListener('addtrack', function (te) {\n              var receiver;\n\n              if (window.RTCPeerConnection.prototype.getReceivers) {\n                receiver = pc.getReceivers().find(function (r) {\n                  return r.track && r.track.id === te.track.id;\n                });\n              } else {\n                receiver = {\n                  track: te.track\n                };\n              }\n\n              var event = new Event('track');\n              event.track = te.track;\n              event.receiver = receiver;\n              event.transceiver = {\n                receiver: receiver\n              };\n              event.streams = [e.stream];\n              pc.dispatchEvent(event);\n            });\n            e.stream.getTracks().forEach(function (track) {\n              var receiver;\n\n              if (window.RTCPeerConnection.prototype.getReceivers) {\n                receiver = pc.getReceivers().find(function (r) {\n                  return r.track && r.track.id === track.id;\n                });\n              } else {\n                receiver = {\n                  track: track\n                };\n              }\n\n              var event = new Event('track');\n              event.track = track;\n              event.receiver = receiver;\n              event.transceiver = {\n                receiver: receiver\n              };\n              event.streams = [e.stream];\n              pc.dispatchEvent(event);\n            });\n          };\n\n          pc.addEventListener('addstream', pc._ontrackpoly);\n        }\n\n        return origSetRemoteDescription.apply(pc, arguments);\n      };\n    } else {\n      // even if RTCRtpTransceiver is in window, it is only used and\n      // emitted in unified-plan. Unfortunately this means we need\n      // to unconditionally wrap the event.\n      utils.wrapPeerConnectionEvent(window, 'track', function (e) {\n        if (!e.transceiver) {\n          Object.defineProperty(e, 'transceiver', {\n            value: {\n              receiver: e.receiver\n            }\n          });\n        }\n\n        return e;\n      });\n    }\n  },\n  shimGetSendersWithDtmf: function (window) {\n    // Overrides addTrack/removeTrack, depends on shimAddTrackRemoveTrack.\n    if (typeof window === 'object' && window.RTCPeerConnection && !('getSenders' in window.RTCPeerConnection.prototype) && 'createDTMFSender' in window.RTCPeerConnection.prototype) {\n      var shimSenderWithDtmf = function (pc, track) {\n        return {\n          track: track,\n\n          get dtmf() {\n            if (this._dtmf === undefined) {\n              if (track.kind === 'audio') {\n                this._dtmf = pc.createDTMFSender(track);\n              } else {\n                this._dtmf = null;\n              }\n            }\n\n            return this._dtmf;\n          },\n\n          _pc: pc\n        };\n      }; // augment addTrack when getSenders is not available.\n\n\n      if (!window.RTCPeerConnection.prototype.getSenders) {\n        window.RTCPeerConnection.prototype.getSenders = function () {\n          this._senders = this._senders || [];\n          return this._senders.slice(); // return a copy of the internal state.\n        };\n\n        var origAddTrack = window.RTCPeerConnection.prototype.addTrack;\n\n        window.RTCPeerConnection.prototype.addTrack = function (track, stream) {\n          var pc = this;\n          var sender = origAddTrack.apply(pc, arguments);\n\n          if (!sender) {\n            sender = shimSenderWithDtmf(pc, track);\n\n            pc._senders.push(sender);\n          }\n\n          return sender;\n        };\n\n        var origRemoveTrack = window.RTCPeerConnection.prototype.removeTrack;\n\n        window.RTCPeerConnection.prototype.removeTrack = function (sender) {\n          var pc = this;\n          origRemoveTrack.apply(pc, arguments);\n\n          var idx = pc._senders.indexOf(sender);\n\n          if (idx !== -1) {\n            pc._senders.splice(idx, 1);\n          }\n        };\n      }\n\n      var origAddStream = window.RTCPeerConnection.prototype.addStream;\n\n      window.RTCPeerConnection.prototype.addStream = function (stream) {\n        var pc = this;\n        pc._senders = pc._senders || [];\n        origAddStream.apply(pc, [stream]);\n        stream.getTracks().forEach(function (track) {\n          pc._senders.push(shimSenderWithDtmf(pc, track));\n        });\n      };\n\n      var origRemoveStream = window.RTCPeerConnection.prototype.removeStream;\n\n      window.RTCPeerConnection.prototype.removeStream = function (stream) {\n        var pc = this;\n        pc._senders = pc._senders || [];\n        origRemoveStream.apply(pc, [stream]);\n        stream.getTracks().forEach(function (track) {\n          var sender = pc._senders.find(function (s) {\n            return s.track === track;\n          });\n\n          if (sender) {\n            pc._senders.splice(pc._senders.indexOf(sender), 1); // remove sender\n\n          }\n        });\n      };\n    } else if (typeof window === 'object' && window.RTCPeerConnection && 'getSenders' in window.RTCPeerConnection.prototype && 'createDTMFSender' in window.RTCPeerConnection.prototype && window.RTCRtpSender && !('dtmf' in window.RTCRtpSender.prototype)) {\n      var origGetSenders = window.RTCPeerConnection.prototype.getSenders;\n\n      window.RTCPeerConnection.prototype.getSenders = function () {\n        var pc = this;\n        var senders = origGetSenders.apply(pc, []);\n        senders.forEach(function (sender) {\n          sender._pc = pc;\n        });\n        return senders;\n      };\n\n      Object.defineProperty(window.RTCRtpSender.prototype, 'dtmf', {\n        get: function () {\n          if (this._dtmf === undefined) {\n            if (this.track.kind === 'audio') {\n              this._dtmf = this._pc.createDTMFSender(this.track);\n            } else {\n              this._dtmf = null;\n            }\n          }\n\n          return this._dtmf;\n        }\n      });\n    }\n  },\n  shimSenderReceiverGetStats: function (window) {\n    if (!(typeof window === 'object' && window.RTCPeerConnection && window.RTCRtpSender && window.RTCRtpReceiver)) {\n      return;\n    } // shim sender stats.\n\n\n    if (!('getStats' in window.RTCRtpSender.prototype)) {\n      var origGetSenders = window.RTCPeerConnection.prototype.getSenders;\n\n      if (origGetSenders) {\n        window.RTCPeerConnection.prototype.getSenders = function () {\n          var pc = this;\n          var senders = origGetSenders.apply(pc, []);\n          senders.forEach(function (sender) {\n            sender._pc = pc;\n          });\n          return senders;\n        };\n      }\n\n      var origAddTrack = window.RTCPeerConnection.prototype.addTrack;\n\n      if (origAddTrack) {\n        window.RTCPeerConnection.prototype.addTrack = function () {\n          var sender = origAddTrack.apply(this, arguments);\n          sender._pc = this;\n          return sender;\n        };\n      }\n\n      window.RTCRtpSender.prototype.getStats = function () {\n        var sender = this;\n        return this._pc.getStats().then(function (result) {\n          /* Note: this will include stats of all senders that\n           *   send a track with the same id as sender.track as\n           *   it is not possible to identify the RTCRtpSender.\n           */\n          return filterStats(result, sender.track, true);\n        });\n      };\n    } // shim receiver stats.\n\n\n    if (!('getStats' in window.RTCRtpReceiver.prototype)) {\n      var origGetReceivers = window.RTCPeerConnection.prototype.getReceivers;\n\n      if (origGetReceivers) {\n        window.RTCPeerConnection.prototype.getReceivers = function () {\n          var pc = this;\n          var receivers = origGetReceivers.apply(pc, []);\n          receivers.forEach(function (receiver) {\n            receiver._pc = pc;\n          });\n          return receivers;\n        };\n      }\n\n      utils.wrapPeerConnectionEvent(window, 'track', function (e) {\n        e.receiver._pc = e.srcElement;\n        return e;\n      });\n\n      window.RTCRtpReceiver.prototype.getStats = function () {\n        var receiver = this;\n        return this._pc.getStats().then(function (result) {\n          return filterStats(result, receiver.track, false);\n        });\n      };\n    }\n\n    if (!('getStats' in window.RTCRtpSender.prototype && 'getStats' in window.RTCRtpReceiver.prototype)) {\n      return;\n    } // shim RTCPeerConnection.getStats(track).\n\n\n    var origGetStats = window.RTCPeerConnection.prototype.getStats;\n\n    window.RTCPeerConnection.prototype.getStats = function () {\n      var pc = this;\n\n      if (arguments.length > 0 && arguments[0] instanceof window.MediaStreamTrack) {\n        var track = arguments[0];\n        var sender;\n        var receiver;\n        var err;\n        pc.getSenders().forEach(function (s) {\n          if (s.track === track) {\n            if (sender) {\n              err = true;\n            } else {\n              sender = s;\n            }\n          }\n        });\n        pc.getReceivers().forEach(function (r) {\n          if (r.track === track) {\n            if (receiver) {\n              err = true;\n            } else {\n              receiver = r;\n            }\n          }\n\n          return r.track === track;\n        });\n\n        if (err || sender && receiver) {\n          return Promise.reject(new DOMException('There are more than one sender or receiver for the track.', 'InvalidAccessError'));\n        } else if (sender) {\n          return sender.getStats();\n        } else if (receiver) {\n          return receiver.getStats();\n        }\n\n        return Promise.reject(new DOMException('There is no sender or receiver for the track.', 'InvalidAccessError'));\n      }\n\n      return origGetStats.apply(pc, arguments);\n    };\n  },\n  shimSourceObject: function (window) {\n    var URL = window && window.URL;\n\n    if (typeof window === 'object') {\n      if (window.HTMLMediaElement && !('srcObject' in window.HTMLMediaElement.prototype)) {\n        // Shim the srcObject property, once, when HTMLMediaElement is found.\n        Object.defineProperty(window.HTMLMediaElement.prototype, 'srcObject', {\n          get: function () {\n            return this._srcObject;\n          },\n          set: function (stream) {\n            var self = this; // Use _srcObject as a private property for this shim\n\n            this._srcObject = stream;\n\n            if (this.src) {\n              URL.revokeObjectURL(this.src);\n            }\n\n            if (!stream) {\n              this.src = '';\n              return undefined;\n            }\n\n            this.src = URL.createObjectURL(stream); // We need to recreate the blob url when a track is added or\n            // removed. Doing it manually since we want to avoid a recursion.\n\n            stream.addEventListener('addtrack', function () {\n              if (self.src) {\n                URL.revokeObjectURL(self.src);\n              }\n\n              self.src = URL.createObjectURL(stream);\n            });\n            stream.addEventListener('removetrack', function () {\n              if (self.src) {\n                URL.revokeObjectURL(self.src);\n              }\n\n              self.src = URL.createObjectURL(stream);\n            });\n          }\n        });\n      }\n    }\n  },\n  shimAddTrackRemoveTrackWithNative: function (window) {\n    // shim addTrack/removeTrack with native variants in order to make\n    // the interactions with legacy getLocalStreams behave as in other browsers.\n    // Keeps a mapping stream.id => [stream, rtpsenders...]\n    window.RTCPeerConnection.prototype.getLocalStreams = function () {\n      var pc = this;\n      this._shimmedLocalStreams = this._shimmedLocalStreams || {};\n      return Object.keys(this._shimmedLocalStreams).map(function (streamId) {\n        return pc._shimmedLocalStreams[streamId][0];\n      });\n    };\n\n    var origAddTrack = window.RTCPeerConnection.prototype.addTrack;\n\n    window.RTCPeerConnection.prototype.addTrack = function (track, stream) {\n      if (!stream) {\n        return origAddTrack.apply(this, arguments);\n      }\n\n      this._shimmedLocalStreams = this._shimmedLocalStreams || {};\n      var sender = origAddTrack.apply(this, arguments);\n\n      if (!this._shimmedLocalStreams[stream.id]) {\n        this._shimmedLocalStreams[stream.id] = [stream, sender];\n      } else if (this._shimmedLocalStreams[stream.id].indexOf(sender) === -1) {\n        this._shimmedLocalStreams[stream.id].push(sender);\n      }\n\n      return sender;\n    };\n\n    var origAddStream = window.RTCPeerConnection.prototype.addStream;\n\n    window.RTCPeerConnection.prototype.addStream = function (stream) {\n      var pc = this;\n      this._shimmedLocalStreams = this._shimmedLocalStreams || {};\n      stream.getTracks().forEach(function (track) {\n        var alreadyExists = pc.getSenders().find(function (s) {\n          return s.track === track;\n        });\n\n        if (alreadyExists) {\n          throw new DOMException('Track already exists.', 'InvalidAccessError');\n        }\n      });\n      var existingSenders = pc.getSenders();\n      origAddStream.apply(this, arguments);\n      var newSenders = pc.getSenders().filter(function (newSender) {\n        return existingSenders.indexOf(newSender) === -1;\n      });\n      this._shimmedLocalStreams[stream.id] = [stream].concat(newSenders);\n    };\n\n    var origRemoveStream = window.RTCPeerConnection.prototype.removeStream;\n\n    window.RTCPeerConnection.prototype.removeStream = function (stream) {\n      this._shimmedLocalStreams = this._shimmedLocalStreams || {};\n      delete this._shimmedLocalStreams[stream.id];\n      return origRemoveStream.apply(this, arguments);\n    };\n\n    var origRemoveTrack = window.RTCPeerConnection.prototype.removeTrack;\n\n    window.RTCPeerConnection.prototype.removeTrack = function (sender) {\n      var pc = this;\n      this._shimmedLocalStreams = this._shimmedLocalStreams || {};\n\n      if (sender) {\n        Object.keys(this._shimmedLocalStreams).forEach(function (streamId) {\n          var idx = pc._shimmedLocalStreams[streamId].indexOf(sender);\n\n          if (idx !== -1) {\n            pc._shimmedLocalStreams[streamId].splice(idx, 1);\n          }\n\n          if (pc._shimmedLocalStreams[streamId].length === 1) {\n            delete pc._shimmedLocalStreams[streamId];\n          }\n        });\n      }\n\n      return origRemoveTrack.apply(this, arguments);\n    };\n  },\n  shimAddTrackRemoveTrack: function (window) {\n    if (!window.RTCPeerConnection) {\n      return;\n    }\n\n    var browserDetails = utils.detectBrowser(window); // shim addTrack and removeTrack.\n\n    if (window.RTCPeerConnection.prototype.addTrack && browserDetails.version >= 65) {\n      return this.shimAddTrackRemoveTrackWithNative(window);\n    } // also shim pc.getLocalStreams when addTrack is shimmed\n    // to return the original streams.\n\n\n    var origGetLocalStreams = window.RTCPeerConnection.prototype.getLocalStreams;\n\n    window.RTCPeerConnection.prototype.getLocalStreams = function () {\n      var pc = this;\n      var nativeStreams = origGetLocalStreams.apply(this);\n      pc._reverseStreams = pc._reverseStreams || {};\n      return nativeStreams.map(function (stream) {\n        return pc._reverseStreams[stream.id];\n      });\n    };\n\n    var origAddStream = window.RTCPeerConnection.prototype.addStream;\n\n    window.RTCPeerConnection.prototype.addStream = function (stream) {\n      var pc = this;\n      pc._streams = pc._streams || {};\n      pc._reverseStreams = pc._reverseStreams || {};\n      stream.getTracks().forEach(function (track) {\n        var alreadyExists = pc.getSenders().find(function (s) {\n          return s.track === track;\n        });\n\n        if (alreadyExists) {\n          throw new DOMException('Track already exists.', 'InvalidAccessError');\n        }\n      }); // Add identity mapping for consistency with addTrack.\n      // Unless this is being used with a stream from addTrack.\n\n      if (!pc._reverseStreams[stream.id]) {\n        var newStream = new window.MediaStream(stream.getTracks());\n        pc._streams[stream.id] = newStream;\n        pc._reverseStreams[newStream.id] = stream;\n        stream = newStream;\n      }\n\n      origAddStream.apply(pc, [stream]);\n    };\n\n    var origRemoveStream = window.RTCPeerConnection.prototype.removeStream;\n\n    window.RTCPeerConnection.prototype.removeStream = function (stream) {\n      var pc = this;\n      pc._streams = pc._streams || {};\n      pc._reverseStreams = pc._reverseStreams || {};\n      origRemoveStream.apply(pc, [pc._streams[stream.id] || stream]);\n      delete pc._reverseStreams[pc._streams[stream.id] ? pc._streams[stream.id].id : stream.id];\n      delete pc._streams[stream.id];\n    };\n\n    window.RTCPeerConnection.prototype.addTrack = function (track, stream) {\n      var pc = this;\n\n      if (pc.signalingState === 'closed') {\n        throw new DOMException('The RTCPeerConnection\\'s signalingState is \\'closed\\'.', 'InvalidStateError');\n      }\n\n      var streams = [].slice.call(arguments, 1);\n\n      if (streams.length !== 1 || !streams[0].getTracks().find(function (t) {\n        return t === track;\n      })) {\n        // this is not fully correct but all we can manage without\n        // [[associated MediaStreams]] internal slot.\n        throw new DOMException('The adapter.js addTrack polyfill only supports a single ' + ' stream which is associated with the specified track.', 'NotSupportedError');\n      }\n\n      var alreadyExists = pc.getSenders().find(function (s) {\n        return s.track === track;\n      });\n\n      if (alreadyExists) {\n        throw new DOMException('Track already exists.', 'InvalidAccessError');\n      }\n\n      pc._streams = pc._streams || {};\n      pc._reverseStreams = pc._reverseStreams || {};\n      var oldStream = pc._streams[stream.id];\n\n      if (oldStream) {\n        // this is using odd Chrome behaviour, use with caution:\n        // https://bugs.chromium.org/p/webrtc/issues/detail?id=7815\n        // Note: we rely on the high-level addTrack/dtmf shim to\n        // create the sender with a dtmf sender.\n        oldStream.addTrack(track); // Trigger ONN async.\n\n        Promise.resolve().then(function () {\n          pc.dispatchEvent(new Event('negotiationneeded'));\n        });\n      } else {\n        var newStream = new window.MediaStream([track]);\n        pc._streams[stream.id] = newStream;\n        pc._reverseStreams[newStream.id] = stream;\n        pc.addStream(newStream);\n      }\n\n      return pc.getSenders().find(function (s) {\n        return s.track === track;\n      });\n    }; // replace the internal stream id with the external one and\n    // vice versa.\n\n\n    function replaceInternalStreamId(pc, description) {\n      var sdp = description.sdp;\n      Object.keys(pc._reverseStreams || []).forEach(function (internalId) {\n        var externalStream = pc._reverseStreams[internalId];\n        var internalStream = pc._streams[externalStream.id];\n        sdp = sdp.replace(new RegExp(internalStream.id, 'g'), externalStream.id);\n      });\n      return new RTCSessionDescription({\n        type: description.type,\n        sdp: sdp\n      });\n    }\n\n    function replaceExternalStreamId(pc, description) {\n      var sdp = description.sdp;\n      Object.keys(pc._reverseStreams || []).forEach(function (internalId) {\n        var externalStream = pc._reverseStreams[internalId];\n        var internalStream = pc._streams[externalStream.id];\n        sdp = sdp.replace(new RegExp(externalStream.id, 'g'), internalStream.id);\n      });\n      return new RTCSessionDescription({\n        type: description.type,\n        sdp: sdp\n      });\n    }\n\n    ['createOffer', 'createAnswer'].forEach(function (method) {\n      var nativeMethod = window.RTCPeerConnection.prototype[method];\n\n      window.RTCPeerConnection.prototype[method] = function () {\n        var pc = this;\n        var args = arguments;\n        var isLegacyCall = arguments.length && typeof arguments[0] === 'function';\n\n        if (isLegacyCall) {\n          return nativeMethod.apply(pc, [function (description) {\n            var desc = replaceInternalStreamId(pc, description);\n            args[0].apply(null, [desc]);\n          }, function (err) {\n            if (args[1]) {\n              args[1].apply(null, err);\n            }\n          }, arguments[2]]);\n        }\n\n        return nativeMethod.apply(pc, arguments).then(function (description) {\n          return replaceInternalStreamId(pc, description);\n        });\n      };\n    });\n    var origSetLocalDescription = window.RTCPeerConnection.prototype.setLocalDescription;\n\n    window.RTCPeerConnection.prototype.setLocalDescription = function () {\n      var pc = this;\n\n      if (!arguments.length || !arguments[0].type) {\n        return origSetLocalDescription.apply(pc, arguments);\n      }\n\n      arguments[0] = replaceExternalStreamId(pc, arguments[0]);\n      return origSetLocalDescription.apply(pc, arguments);\n    }; // TODO: mangle getStats: https://w3c.github.io/webrtc-stats/#dom-rtcmediastreamstats-streamidentifier\n\n\n    var origLocalDescription = Object.getOwnPropertyDescriptor(window.RTCPeerConnection.prototype, 'localDescription');\n    Object.defineProperty(window.RTCPeerConnection.prototype, 'localDescription', {\n      get: function () {\n        var pc = this;\n        var description = origLocalDescription.get.apply(this);\n\n        if (description.type === '') {\n          return description;\n        }\n\n        return replaceInternalStreamId(pc, description);\n      }\n    });\n\n    window.RTCPeerConnection.prototype.removeTrack = function (sender) {\n      var pc = this;\n\n      if (pc.signalingState === 'closed') {\n        throw new DOMException('The RTCPeerConnection\\'s signalingState is \\'closed\\'.', 'InvalidStateError');\n      } // We can not yet check for sender instanceof RTCRtpSender\n      // since we shim RTPSender. So we check if sender._pc is set.\n\n\n      if (!sender._pc) {\n        throw new DOMException('Argument 1 of RTCPeerConnection.removeTrack ' + 'does not implement interface RTCRtpSender.', 'TypeError');\n      }\n\n      var isLocal = sender._pc === pc;\n\n      if (!isLocal) {\n        throw new DOMException('Sender was not created by this connection.', 'InvalidAccessError');\n      } // Search for the native stream the senders track belongs to.\n\n\n      pc._streams = pc._streams || {};\n      var stream;\n      Object.keys(pc._streams).forEach(function (streamid) {\n        var hasTrack = pc._streams[streamid].getTracks().find(function (track) {\n          return sender.track === track;\n        });\n\n        if (hasTrack) {\n          stream = pc._streams[streamid];\n        }\n      });\n\n      if (stream) {\n        if (stream.getTracks().length === 1) {\n          // if this is the last track of the stream, remove the stream. This\n          // takes care of any shimmed _senders.\n          pc.removeStream(pc._reverseStreams[stream.id]);\n        } else {\n          // relying on the same odd chrome behaviour as above.\n          stream.removeTrack(sender.track);\n        }\n\n        pc.dispatchEvent(new Event('negotiationneeded'));\n      }\n    };\n  },\n  shimPeerConnection: function (window) {\n    var browserDetails = utils.detectBrowser(window); // The RTCPeerConnection object.\n\n    if (!window.RTCPeerConnection && window.webkitRTCPeerConnection) {\n      window.RTCPeerConnection = function (pcConfig, pcConstraints) {\n        // Translate iceTransportPolicy to iceTransports,\n        // see https://code.google.com/p/webrtc/issues/detail?id=4869\n        // this was fixed in M56 along with unprefixing RTCPeerConnection.\n        logging('PeerConnection');\n\n        if (pcConfig && pcConfig.iceTransportPolicy) {\n          pcConfig.iceTransports = pcConfig.iceTransportPolicy;\n        }\n\n        return new window.webkitRTCPeerConnection(pcConfig, pcConstraints);\n      };\n\n      window.RTCPeerConnection.prototype = window.webkitRTCPeerConnection.prototype; // wrap static methods. Currently just generateCertificate.\n\n      if (window.webkitRTCPeerConnection.generateCertificate) {\n        Object.defineProperty(window.RTCPeerConnection, 'generateCertificate', {\n          get: function () {\n            return window.webkitRTCPeerConnection.generateCertificate;\n          }\n        });\n      }\n    }\n\n    if (!window.RTCPeerConnection) {\n      return;\n    }\n\n    var origGetStats = window.RTCPeerConnection.prototype.getStats;\n\n    window.RTCPeerConnection.prototype.getStats = function (selector, successCallback, errorCallback) {\n      var pc = this;\n      var args = arguments; // If selector is a function then we are in the old style stats so just\n      // pass back the original getStats format to avoid breaking old users.\n\n      if (arguments.length > 0 && typeof selector === 'function') {\n        return origGetStats.apply(this, arguments);\n      } // When spec-style getStats is supported, return those when called with\n      // either no arguments or the selector argument is null.\n\n\n      if (origGetStats.length === 0 && (arguments.length === 0 || typeof arguments[0] !== 'function')) {\n        return origGetStats.apply(this, []);\n      }\n\n      var fixChromeStats_ = function (response) {\n        var standardReport = {};\n        var reports = response.result();\n        reports.forEach(function (report) {\n          var standardStats = {\n            id: report.id,\n            timestamp: report.timestamp,\n            type: {\n              localcandidate: 'local-candidate',\n              remotecandidate: 'remote-candidate'\n            }[report.type] || report.type\n          };\n          report.names().forEach(function (name) {\n            standardStats[name] = report.stat(name);\n          });\n          standardReport[standardStats.id] = standardStats;\n        });\n        return standardReport;\n      }; // shim getStats with maplike support\n\n\n      var makeMapStats = function (stats) {\n        return new Map(Object.keys(stats).map(function (key) {\n          return [key, stats[key]];\n        }));\n      };\n\n      if (arguments.length >= 2) {\n        var successCallbackWrapper_ = function (response) {\n          args[1](makeMapStats(fixChromeStats_(response)));\n        };\n\n        return origGetStats.apply(this, [successCallbackWrapper_, arguments[0]]);\n      } // promise-support\n\n\n      return new Promise(function (resolve, reject) {\n        origGetStats.apply(pc, [function (response) {\n          resolve(makeMapStats(fixChromeStats_(response)));\n        }, reject]);\n      }).then(successCallback, errorCallback);\n    }; // add promise support -- natively available in Chrome 51\n\n\n    if (browserDetails.version < 51) {\n      ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate'].forEach(function (method) {\n        var nativeMethod = window.RTCPeerConnection.prototype[method];\n\n        window.RTCPeerConnection.prototype[method] = function () {\n          var args = arguments;\n          var pc = this;\n          var promise = new Promise(function (resolve, reject) {\n            nativeMethod.apply(pc, [args[0], resolve, reject]);\n          });\n\n          if (args.length < 2) {\n            return promise;\n          }\n\n          return promise.then(function () {\n            args[1].apply(null, []);\n          }, function (err) {\n            if (args.length >= 3) {\n              args[2].apply(null, [err]);\n            }\n          });\n        };\n      });\n    } // promise support for createOffer and createAnswer. Available (without\n    // bugs) since M52: crbug/619289\n\n\n    if (browserDetails.version < 52) {\n      ['createOffer', 'createAnswer'].forEach(function (method) {\n        var nativeMethod = window.RTCPeerConnection.prototype[method];\n\n        window.RTCPeerConnection.prototype[method] = function () {\n          var pc = this;\n\n          if (arguments.length < 1 || arguments.length === 1 && typeof arguments[0] === 'object') {\n            var opts = arguments.length === 1 ? arguments[0] : undefined;\n            return new Promise(function (resolve, reject) {\n              nativeMethod.apply(pc, [resolve, reject, opts]);\n            });\n          }\n\n          return nativeMethod.apply(this, arguments);\n        };\n      });\n    } // shim implicit creation of RTCSessionDescription/RTCIceCandidate\n\n\n    ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate'].forEach(function (method) {\n      var nativeMethod = window.RTCPeerConnection.prototype[method];\n\n      window.RTCPeerConnection.prototype[method] = function () {\n        arguments[0] = new (method === 'addIceCandidate' ? window.RTCIceCandidate : window.RTCSessionDescription)(arguments[0]);\n        return nativeMethod.apply(this, arguments);\n      };\n    }); // support for addIceCandidate(null or undefined)\n\n    var nativeAddIceCandidate = window.RTCPeerConnection.prototype.addIceCandidate;\n\n    window.RTCPeerConnection.prototype.addIceCandidate = function () {\n      if (!arguments[0]) {\n        if (arguments[1]) {\n          arguments[1].apply(null);\n        }\n\n        return Promise.resolve();\n      }\n\n      return nativeAddIceCandidate.apply(this, arguments);\n    };\n  },\n  fixNegotiationNeeded: function (window) {\n    utils.wrapPeerConnectionEvent(window, 'negotiationneeded', function (e) {\n      var pc = e.target;\n\n      if (pc.signalingState !== 'stable') {\n        return;\n      }\n\n      return e;\n    });\n  },\n  shimGetDisplayMedia: function (window, getSourceId) {\n    if (!window.navigator || !window.navigator.mediaDevices || 'getDisplayMedia' in window.navigator.mediaDevices) {\n      return;\n    } // getSourceId is a function that returns a promise resolving with\n    // the sourceId of the screen/window/tab to be shared.\n\n\n    if (typeof getSourceId !== 'function') {\n      console.error('shimGetDisplayMedia: getSourceId argument is not ' + 'a function');\n      return;\n    }\n\n    window.navigator.mediaDevices.getDisplayMedia = function (constraints) {\n      return getSourceId(constraints).then(function (sourceId) {\n        var widthSpecified = constraints.video && constraints.video.width;\n        var heightSpecified = constraints.video && constraints.video.height;\n        var frameRateSpecified = constraints.video && constraints.video.frameRate;\n        constraints.video = {\n          mandatory: {\n            chromeMediaSource: 'desktop',\n            chromeMediaSourceId: sourceId,\n            maxFrameRate: frameRateSpecified || 3\n          }\n        };\n\n        if (widthSpecified) {\n          constraints.video.mandatory.maxWidth = widthSpecified;\n        }\n\n        if (heightSpecified) {\n          constraints.video.mandatory.maxHeight = heightSpecified;\n        }\n\n        return window.navigator.mediaDevices.getUserMedia(constraints);\n      });\n    };\n\n    window.navigator.getDisplayMedia = function (constraints) {\n      utils.deprecated('navigator.getDisplayMedia', 'navigator.mediaDevices.getDisplayMedia');\n      return window.navigator.mediaDevices.getDisplayMedia(constraints);\n    };\n  }\n};","map":{"version":3,"sources":["/home/ryan/dev/defi/bridge/node_modules/@myetherwallet/mewconnect-web-client/node_modules/webrtc-adapter/src/js/chrome/chrome_shim.js"],"names":["utils","require","logging","log","walkStats","stats","base","resultSet","has","id","set","Object","keys","forEach","name","endsWith","get","filterStats","result","track","outbound","streamStatsType","filteredResult","Map","trackStats","value","type","trackIdentifier","push","trackStat","trackId","module","exports","shimGetUserMedia","shimMediaStream","window","MediaStream","webkitMediaStream","shimOnTrack","RTCPeerConnection","prototype","defineProperty","_ontrack","f","removeEventListener","addEventListener","enumerable","configurable","origSetRemoteDescription","setRemoteDescription","pc","_ontrackpoly","e","stream","te","receiver","getReceivers","find","r","event","Event","transceiver","streams","dispatchEvent","getTracks","apply","arguments","wrapPeerConnectionEvent","shimGetSendersWithDtmf","shimSenderWithDtmf","dtmf","_dtmf","undefined","kind","createDTMFSender","_pc","getSenders","_senders","slice","origAddTrack","addTrack","sender","origRemoveTrack","removeTrack","idx","indexOf","splice","origAddStream","addStream","origRemoveStream","removeStream","s","RTCRtpSender","origGetSenders","senders","shimSenderReceiverGetStats","RTCRtpReceiver","getStats","then","origGetReceivers","receivers","srcElement","origGetStats","length","MediaStreamTrack","err","Promise","reject","DOMException","shimSourceObject","URL","HTMLMediaElement","_srcObject","self","src","revokeObjectURL","createObjectURL","shimAddTrackRemoveTrackWithNative","getLocalStreams","_shimmedLocalStreams","map","streamId","alreadyExists","existingSenders","newSenders","filter","newSender","concat","shimAddTrackRemoveTrack","browserDetails","detectBrowser","version","origGetLocalStreams","nativeStreams","_reverseStreams","_streams","newStream","signalingState","call","t","oldStream","resolve","replaceInternalStreamId","description","sdp","internalId","externalStream","internalStream","replace","RegExp","RTCSessionDescription","replaceExternalStreamId","method","nativeMethod","args","isLegacyCall","desc","origSetLocalDescription","setLocalDescription","origLocalDescription","getOwnPropertyDescriptor","isLocal","streamid","hasTrack","shimPeerConnection","webkitRTCPeerConnection","pcConfig","pcConstraints","iceTransportPolicy","iceTransports","generateCertificate","selector","successCallback","errorCallback","fixChromeStats_","response","standardReport","reports","report","standardStats","timestamp","localcandidate","remotecandidate","names","stat","makeMapStats","key","successCallbackWrapper_","promise","opts","RTCIceCandidate","nativeAddIceCandidate","addIceCandidate","fixNegotiationNeeded","target","shimGetDisplayMedia","getSourceId","navigator","mediaDevices","console","error","getDisplayMedia","constraints","sourceId","widthSpecified","video","width","heightSpecified","height","frameRateSpecified","frameRate","mandatory","chromeMediaSource","chromeMediaSourceId","maxFrameRate","maxWidth","maxHeight","getUserMedia","deprecated"],"mappings":"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","sourcesContent":["\n/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n /* eslint-env node */\n'use strict';\nvar utils = require('../utils.js');\nvar logging = utils.log;\n\n/* iterates the stats graph recursively. */\nfunction walkStats(stats, base, resultSet) {\n  if (!base || resultSet.has(base.id)) {\n    return;\n  }\n  resultSet.set(base.id, base);\n  Object.keys(base).forEach(function(name) {\n    if (name.endsWith('Id')) {\n      walkStats(stats, stats.get(base[name]), resultSet);\n    } else if (name.endsWith('Ids')) {\n      base[name].forEach(function(id) {\n        walkStats(stats, stats.get(id), resultSet);\n      });\n    }\n  });\n}\n\n/* filter getStats for a sender/receiver track. */\nfunction filterStats(result, track, outbound) {\n  var streamStatsType = outbound ? 'outbound-rtp' : 'inbound-rtp';\n  var filteredResult = new Map();\n  if (track === null) {\n    return filteredResult;\n  }\n  var trackStats = [];\n  result.forEach(function(value) {\n    if (value.type === 'track' &&\n        value.trackIdentifier === track.id) {\n      trackStats.push(value);\n    }\n  });\n  trackStats.forEach(function(trackStat) {\n    result.forEach(function(stats) {\n      if (stats.type === streamStatsType && stats.trackId === trackStat.id) {\n        walkStats(result, stats, filteredResult);\n      }\n    });\n  });\n  return filteredResult;\n}\n\nmodule.exports = {\n  shimGetUserMedia: require('./getusermedia'),\n  shimMediaStream: function(window) {\n    window.MediaStream = window.MediaStream || window.webkitMediaStream;\n  },\n\n  shimOnTrack: function(window) {\n    if (typeof window === 'object' && window.RTCPeerConnection && !('ontrack' in\n        window.RTCPeerConnection.prototype)) {\n      Object.defineProperty(window.RTCPeerConnection.prototype, 'ontrack', {\n        get: function() {\n          return this._ontrack;\n        },\n        set: function(f) {\n          if (this._ontrack) {\n            this.removeEventListener('track', this._ontrack);\n          }\n          this.addEventListener('track', this._ontrack = f);\n        },\n        enumerable: true,\n        configurable: true\n      });\n      var origSetRemoteDescription =\n          window.RTCPeerConnection.prototype.setRemoteDescription;\n      window.RTCPeerConnection.prototype.setRemoteDescription = function() {\n        var pc = this;\n        if (!pc._ontrackpoly) {\n          pc._ontrackpoly = function(e) {\n            // onaddstream does not fire when a track is added to an existing\n            // stream. But stream.onaddtrack is implemented so we use that.\n            e.stream.addEventListener('addtrack', function(te) {\n              var receiver;\n              if (window.RTCPeerConnection.prototype.getReceivers) {\n                receiver = pc.getReceivers().find(function(r) {\n                  return r.track && r.track.id === te.track.id;\n                });\n              } else {\n                receiver = {track: te.track};\n              }\n\n              var event = new Event('track');\n              event.track = te.track;\n              event.receiver = receiver;\n              event.transceiver = {receiver: receiver};\n              event.streams = [e.stream];\n              pc.dispatchEvent(event);\n            });\n            e.stream.getTracks().forEach(function(track) {\n              var receiver;\n              if (window.RTCPeerConnection.prototype.getReceivers) {\n                receiver = pc.getReceivers().find(function(r) {\n                  return r.track && r.track.id === track.id;\n                });\n              } else {\n                receiver = {track: track};\n              }\n              var event = new Event('track');\n              event.track = track;\n              event.receiver = receiver;\n              event.transceiver = {receiver: receiver};\n              event.streams = [e.stream];\n              pc.dispatchEvent(event);\n            });\n          };\n          pc.addEventListener('addstream', pc._ontrackpoly);\n        }\n        return origSetRemoteDescription.apply(pc, arguments);\n      };\n    } else {\n      // even if RTCRtpTransceiver is in window, it is only used and\n      // emitted in unified-plan. Unfortunately this means we need\n      // to unconditionally wrap the event.\n      utils.wrapPeerConnectionEvent(window, 'track', function(e) {\n        if (!e.transceiver) {\n          Object.defineProperty(e, 'transceiver',\n            {value: {receiver: e.receiver}});\n        }\n        return e;\n      });\n    }\n  },\n\n  shimGetSendersWithDtmf: function(window) {\n    // Overrides addTrack/removeTrack, depends on shimAddTrackRemoveTrack.\n    if (typeof window === 'object' && window.RTCPeerConnection &&\n        !('getSenders' in window.RTCPeerConnection.prototype) &&\n        'createDTMFSender' in window.RTCPeerConnection.prototype) {\n      var shimSenderWithDtmf = function(pc, track) {\n        return {\n          track: track,\n          get dtmf() {\n            if (this._dtmf === undefined) {\n              if (track.kind === 'audio') {\n                this._dtmf = pc.createDTMFSender(track);\n              } else {\n                this._dtmf = null;\n              }\n            }\n            return this._dtmf;\n          },\n          _pc: pc\n        };\n      };\n\n      // augment addTrack when getSenders is not available.\n      if (!window.RTCPeerConnection.prototype.getSenders) {\n        window.RTCPeerConnection.prototype.getSenders = function() {\n          this._senders = this._senders || [];\n          return this._senders.slice(); // return a copy of the internal state.\n        };\n        var origAddTrack = window.RTCPeerConnection.prototype.addTrack;\n        window.RTCPeerConnection.prototype.addTrack = function(track, stream) {\n          var pc = this;\n          var sender = origAddTrack.apply(pc, arguments);\n          if (!sender) {\n            sender = shimSenderWithDtmf(pc, track);\n            pc._senders.push(sender);\n          }\n          return sender;\n        };\n\n        var origRemoveTrack = window.RTCPeerConnection.prototype.removeTrack;\n        window.RTCPeerConnection.prototype.removeTrack = function(sender) {\n          var pc = this;\n          origRemoveTrack.apply(pc, arguments);\n          var idx = pc._senders.indexOf(sender);\n          if (idx !== -1) {\n            pc._senders.splice(idx, 1);\n          }\n        };\n      }\n      var origAddStream = window.RTCPeerConnection.prototype.addStream;\n      window.RTCPeerConnection.prototype.addStream = function(stream) {\n        var pc = this;\n        pc._senders = pc._senders || [];\n        origAddStream.apply(pc, [stream]);\n        stream.getTracks().forEach(function(track) {\n          pc._senders.push(shimSenderWithDtmf(pc, track));\n        });\n      };\n\n      var origRemoveStream = window.RTCPeerConnection.prototype.removeStream;\n      window.RTCPeerConnection.prototype.removeStream = function(stream) {\n        var pc = this;\n        pc._senders = pc._senders || [];\n        origRemoveStream.apply(pc, [stream]);\n\n        stream.getTracks().forEach(function(track) {\n          var sender = pc._senders.find(function(s) {\n            return s.track === track;\n          });\n          if (sender) {\n            pc._senders.splice(pc._senders.indexOf(sender), 1); // remove sender\n          }\n        });\n      };\n    } else if (typeof window === 'object' && window.RTCPeerConnection &&\n               'getSenders' in window.RTCPeerConnection.prototype &&\n               'createDTMFSender' in window.RTCPeerConnection.prototype &&\n               window.RTCRtpSender &&\n               !('dtmf' in window.RTCRtpSender.prototype)) {\n      var origGetSenders = window.RTCPeerConnection.prototype.getSenders;\n      window.RTCPeerConnection.prototype.getSenders = function() {\n        var pc = this;\n        var senders = origGetSenders.apply(pc, []);\n        senders.forEach(function(sender) {\n          sender._pc = pc;\n        });\n        return senders;\n      };\n\n      Object.defineProperty(window.RTCRtpSender.prototype, 'dtmf', {\n        get: function() {\n          if (this._dtmf === undefined) {\n            if (this.track.kind === 'audio') {\n              this._dtmf = this._pc.createDTMFSender(this.track);\n            } else {\n              this._dtmf = null;\n            }\n          }\n          return this._dtmf;\n        }\n      });\n    }\n  },\n\n  shimSenderReceiverGetStats: function(window) {\n    if (!(typeof window === 'object' && window.RTCPeerConnection &&\n        window.RTCRtpSender && window.RTCRtpReceiver)) {\n      return;\n    }\n\n    // shim sender stats.\n    if (!('getStats' in window.RTCRtpSender.prototype)) {\n      var origGetSenders = window.RTCPeerConnection.prototype.getSenders;\n      if (origGetSenders) {\n        window.RTCPeerConnection.prototype.getSenders = function() {\n          var pc = this;\n          var senders = origGetSenders.apply(pc, []);\n          senders.forEach(function(sender) {\n            sender._pc = pc;\n          });\n          return senders;\n        };\n      }\n\n      var origAddTrack = window.RTCPeerConnection.prototype.addTrack;\n      if (origAddTrack) {\n        window.RTCPeerConnection.prototype.addTrack = function() {\n          var sender = origAddTrack.apply(this, arguments);\n          sender._pc = this;\n          return sender;\n        };\n      }\n      window.RTCRtpSender.prototype.getStats = function() {\n        var sender = this;\n        return this._pc.getStats().then(function(result) {\n          /* Note: this will include stats of all senders that\n           *   send a track with the same id as sender.track as\n           *   it is not possible to identify the RTCRtpSender.\n           */\n          return filterStats(result, sender.track, true);\n        });\n      };\n    }\n\n    // shim receiver stats.\n    if (!('getStats' in window.RTCRtpReceiver.prototype)) {\n      var origGetReceivers = window.RTCPeerConnection.prototype.getReceivers;\n      if (origGetReceivers) {\n        window.RTCPeerConnection.prototype.getReceivers = function() {\n          var pc = this;\n          var receivers = origGetReceivers.apply(pc, []);\n          receivers.forEach(function(receiver) {\n            receiver._pc = pc;\n          });\n          return receivers;\n        };\n      }\n      utils.wrapPeerConnectionEvent(window, 'track', function(e) {\n        e.receiver._pc = e.srcElement;\n        return e;\n      });\n      window.RTCRtpReceiver.prototype.getStats = function() {\n        var receiver = this;\n        return this._pc.getStats().then(function(result) {\n          return filterStats(result, receiver.track, false);\n        });\n      };\n    }\n\n    if (!('getStats' in window.RTCRtpSender.prototype &&\n        'getStats' in window.RTCRtpReceiver.prototype)) {\n      return;\n    }\n\n    // shim RTCPeerConnection.getStats(track).\n    var origGetStats = window.RTCPeerConnection.prototype.getStats;\n    window.RTCPeerConnection.prototype.getStats = function() {\n      var pc = this;\n      if (arguments.length > 0 &&\n          arguments[0] instanceof window.MediaStreamTrack) {\n        var track = arguments[0];\n        var sender;\n        var receiver;\n        var err;\n        pc.getSenders().forEach(function(s) {\n          if (s.track === track) {\n            if (sender) {\n              err = true;\n            } else {\n              sender = s;\n            }\n          }\n        });\n        pc.getReceivers().forEach(function(r) {\n          if (r.track === track) {\n            if (receiver) {\n              err = true;\n            } else {\n              receiver = r;\n            }\n          }\n          return r.track === track;\n        });\n        if (err || (sender && receiver)) {\n          return Promise.reject(new DOMException(\n            'There are more than one sender or receiver for the track.',\n            'InvalidAccessError'));\n        } else if (sender) {\n          return sender.getStats();\n        } else if (receiver) {\n          return receiver.getStats();\n        }\n        return Promise.reject(new DOMException(\n          'There is no sender or receiver for the track.',\n          'InvalidAccessError'));\n      }\n      return origGetStats.apply(pc, arguments);\n    };\n  },\n\n  shimSourceObject: function(window) {\n    var URL = window && window.URL;\n\n    if (typeof window === 'object') {\n      if (window.HTMLMediaElement &&\n        !('srcObject' in window.HTMLMediaElement.prototype)) {\n        // Shim the srcObject property, once, when HTMLMediaElement is found.\n        Object.defineProperty(window.HTMLMediaElement.prototype, 'srcObject', {\n          get: function() {\n            return this._srcObject;\n          },\n          set: function(stream) {\n            var self = this;\n            // Use _srcObject as a private property for this shim\n            this._srcObject = stream;\n            if (this.src) {\n              URL.revokeObjectURL(this.src);\n            }\n\n            if (!stream) {\n              this.src = '';\n              return undefined;\n            }\n            this.src = URL.createObjectURL(stream);\n            // We need to recreate the blob url when a track is added or\n            // removed. Doing it manually since we want to avoid a recursion.\n            stream.addEventListener('addtrack', function() {\n              if (self.src) {\n                URL.revokeObjectURL(self.src);\n              }\n              self.src = URL.createObjectURL(stream);\n            });\n            stream.addEventListener('removetrack', function() {\n              if (self.src) {\n                URL.revokeObjectURL(self.src);\n              }\n              self.src = URL.createObjectURL(stream);\n            });\n          }\n        });\n      }\n    }\n  },\n\n  shimAddTrackRemoveTrackWithNative: function(window) {\n    // shim addTrack/removeTrack with native variants in order to make\n    // the interactions with legacy getLocalStreams behave as in other browsers.\n    // Keeps a mapping stream.id => [stream, rtpsenders...]\n    window.RTCPeerConnection.prototype.getLocalStreams = function() {\n      var pc = this;\n      this._shimmedLocalStreams = this._shimmedLocalStreams || {};\n      return Object.keys(this._shimmedLocalStreams).map(function(streamId) {\n        return pc._shimmedLocalStreams[streamId][0];\n      });\n    };\n\n    var origAddTrack = window.RTCPeerConnection.prototype.addTrack;\n    window.RTCPeerConnection.prototype.addTrack = function(track, stream) {\n      if (!stream) {\n        return origAddTrack.apply(this, arguments);\n      }\n      this._shimmedLocalStreams = this._shimmedLocalStreams || {};\n\n      var sender = origAddTrack.apply(this, arguments);\n      if (!this._shimmedLocalStreams[stream.id]) {\n        this._shimmedLocalStreams[stream.id] = [stream, sender];\n      } else if (this._shimmedLocalStreams[stream.id].indexOf(sender) === -1) {\n        this._shimmedLocalStreams[stream.id].push(sender);\n      }\n      return sender;\n    };\n\n    var origAddStream = window.RTCPeerConnection.prototype.addStream;\n    window.RTCPeerConnection.prototype.addStream = function(stream) {\n      var pc = this;\n      this._shimmedLocalStreams = this._shimmedLocalStreams || {};\n\n      stream.getTracks().forEach(function(track) {\n        var alreadyExists = pc.getSenders().find(function(s) {\n          return s.track === track;\n        });\n        if (alreadyExists) {\n          throw new DOMException('Track already exists.',\n              'InvalidAccessError');\n        }\n      });\n      var existingSenders = pc.getSenders();\n      origAddStream.apply(this, arguments);\n      var newSenders = pc.getSenders().filter(function(newSender) {\n        return existingSenders.indexOf(newSender) === -1;\n      });\n      this._shimmedLocalStreams[stream.id] = [stream].concat(newSenders);\n    };\n\n    var origRemoveStream = window.RTCPeerConnection.prototype.removeStream;\n    window.RTCPeerConnection.prototype.removeStream = function(stream) {\n      this._shimmedLocalStreams = this._shimmedLocalStreams || {};\n      delete this._shimmedLocalStreams[stream.id];\n      return origRemoveStream.apply(this, arguments);\n    };\n\n    var origRemoveTrack = window.RTCPeerConnection.prototype.removeTrack;\n    window.RTCPeerConnection.prototype.removeTrack = function(sender) {\n      var pc = this;\n      this._shimmedLocalStreams = this._shimmedLocalStreams || {};\n      if (sender) {\n        Object.keys(this._shimmedLocalStreams).forEach(function(streamId) {\n          var idx = pc._shimmedLocalStreams[streamId].indexOf(sender);\n          if (idx !== -1) {\n            pc._shimmedLocalStreams[streamId].splice(idx, 1);\n          }\n          if (pc._shimmedLocalStreams[streamId].length === 1) {\n            delete pc._shimmedLocalStreams[streamId];\n          }\n        });\n      }\n      return origRemoveTrack.apply(this, arguments);\n    };\n  },\n\n  shimAddTrackRemoveTrack: function(window) {\n    if (!window.RTCPeerConnection) {\n      return;\n    }\n    var browserDetails = utils.detectBrowser(window);\n    // shim addTrack and removeTrack.\n    if (window.RTCPeerConnection.prototype.addTrack &&\n        browserDetails.version >= 65) {\n      return this.shimAddTrackRemoveTrackWithNative(window);\n    }\n\n    // also shim pc.getLocalStreams when addTrack is shimmed\n    // to return the original streams.\n    var origGetLocalStreams = window.RTCPeerConnection.prototype\n        .getLocalStreams;\n    window.RTCPeerConnection.prototype.getLocalStreams = function() {\n      var pc = this;\n      var nativeStreams = origGetLocalStreams.apply(this);\n      pc._reverseStreams = pc._reverseStreams || {};\n      return nativeStreams.map(function(stream) {\n        return pc._reverseStreams[stream.id];\n      });\n    };\n\n    var origAddStream = window.RTCPeerConnection.prototype.addStream;\n    window.RTCPeerConnection.prototype.addStream = function(stream) {\n      var pc = this;\n      pc._streams = pc._streams || {};\n      pc._reverseStreams = pc._reverseStreams || {};\n\n      stream.getTracks().forEach(function(track) {\n        var alreadyExists = pc.getSenders().find(function(s) {\n          return s.track === track;\n        });\n        if (alreadyExists) {\n          throw new DOMException('Track already exists.',\n              'InvalidAccessError');\n        }\n      });\n      // Add identity mapping for consistency with addTrack.\n      // Unless this is being used with a stream from addTrack.\n      if (!pc._reverseStreams[stream.id]) {\n        var newStream = new window.MediaStream(stream.getTracks());\n        pc._streams[stream.id] = newStream;\n        pc._reverseStreams[newStream.id] = stream;\n        stream = newStream;\n      }\n      origAddStream.apply(pc, [stream]);\n    };\n\n    var origRemoveStream = window.RTCPeerConnection.prototype.removeStream;\n    window.RTCPeerConnection.prototype.removeStream = function(stream) {\n      var pc = this;\n      pc._streams = pc._streams || {};\n      pc._reverseStreams = pc._reverseStreams || {};\n\n      origRemoveStream.apply(pc, [(pc._streams[stream.id] || stream)]);\n      delete pc._reverseStreams[(pc._streams[stream.id] ?\n          pc._streams[stream.id].id : stream.id)];\n      delete pc._streams[stream.id];\n    };\n\n    window.RTCPeerConnection.prototype.addTrack = function(track, stream) {\n      var pc = this;\n      if (pc.signalingState === 'closed') {\n        throw new DOMException(\n          'The RTCPeerConnection\\'s signalingState is \\'closed\\'.',\n          'InvalidStateError');\n      }\n      var streams = [].slice.call(arguments, 1);\n      if (streams.length !== 1 ||\n          !streams[0].getTracks().find(function(t) {\n            return t === track;\n          })) {\n        // this is not fully correct but all we can manage without\n        // [[associated MediaStreams]] internal slot.\n        throw new DOMException(\n          'The adapter.js addTrack polyfill only supports a single ' +\n          ' stream which is associated with the specified track.',\n          'NotSupportedError');\n      }\n\n      var alreadyExists = pc.getSenders().find(function(s) {\n        return s.track === track;\n      });\n      if (alreadyExists) {\n        throw new DOMException('Track already exists.',\n            'InvalidAccessError');\n      }\n\n      pc._streams = pc._streams || {};\n      pc._reverseStreams = pc._reverseStreams || {};\n      var oldStream = pc._streams[stream.id];\n      if (oldStream) {\n        // this is using odd Chrome behaviour, use with caution:\n        // https://bugs.chromium.org/p/webrtc/issues/detail?id=7815\n        // Note: we rely on the high-level addTrack/dtmf shim to\n        // create the sender with a dtmf sender.\n        oldStream.addTrack(track);\n\n        // Trigger ONN async.\n        Promise.resolve().then(function() {\n          pc.dispatchEvent(new Event('negotiationneeded'));\n        });\n      } else {\n        var newStream = new window.MediaStream([track]);\n        pc._streams[stream.id] = newStream;\n        pc._reverseStreams[newStream.id] = stream;\n        pc.addStream(newStream);\n      }\n      return pc.getSenders().find(function(s) {\n        return s.track === track;\n      });\n    };\n\n    // replace the internal stream id with the external one and\n    // vice versa.\n    function replaceInternalStreamId(pc, description) {\n      var sdp = description.sdp;\n      Object.keys(pc._reverseStreams || []).forEach(function(internalId) {\n        var externalStream = pc._reverseStreams[internalId];\n        var internalStream = pc._streams[externalStream.id];\n        sdp = sdp.replace(new RegExp(internalStream.id, 'g'),\n            externalStream.id);\n      });\n      return new RTCSessionDescription({\n        type: description.type,\n        sdp: sdp\n      });\n    }\n    function replaceExternalStreamId(pc, description) {\n      var sdp = description.sdp;\n      Object.keys(pc._reverseStreams || []).forEach(function(internalId) {\n        var externalStream = pc._reverseStreams[internalId];\n        var internalStream = pc._streams[externalStream.id];\n        sdp = sdp.replace(new RegExp(externalStream.id, 'g'),\n            internalStream.id);\n      });\n      return new RTCSessionDescription({\n        type: description.type,\n        sdp: sdp\n      });\n    }\n    ['createOffer', 'createAnswer'].forEach(function(method) {\n      var nativeMethod = window.RTCPeerConnection.prototype[method];\n      window.RTCPeerConnection.prototype[method] = function() {\n        var pc = this;\n        var args = arguments;\n        var isLegacyCall = arguments.length &&\n            typeof arguments[0] === 'function';\n        if (isLegacyCall) {\n          return nativeMethod.apply(pc, [\n            function(description) {\n              var desc = replaceInternalStreamId(pc, description);\n              args[0].apply(null, [desc]);\n            },\n            function(err) {\n              if (args[1]) {\n                args[1].apply(null, err);\n              }\n            }, arguments[2]\n          ]);\n        }\n        return nativeMethod.apply(pc, arguments)\n        .then(function(description) {\n          return replaceInternalStreamId(pc, description);\n        });\n      };\n    });\n\n    var origSetLocalDescription =\n        window.RTCPeerConnection.prototype.setLocalDescription;\n    window.RTCPeerConnection.prototype.setLocalDescription = function() {\n      var pc = this;\n      if (!arguments.length || !arguments[0].type) {\n        return origSetLocalDescription.apply(pc, arguments);\n      }\n      arguments[0] = replaceExternalStreamId(pc, arguments[0]);\n      return origSetLocalDescription.apply(pc, arguments);\n    };\n\n    // TODO: mangle getStats: https://w3c.github.io/webrtc-stats/#dom-rtcmediastreamstats-streamidentifier\n\n    var origLocalDescription = Object.getOwnPropertyDescriptor(\n        window.RTCPeerConnection.prototype, 'localDescription');\n    Object.defineProperty(window.RTCPeerConnection.prototype,\n        'localDescription', {\n          get: function() {\n            var pc = this;\n            var description = origLocalDescription.get.apply(this);\n            if (description.type === '') {\n              return description;\n            }\n            return replaceInternalStreamId(pc, description);\n          }\n        });\n\n    window.RTCPeerConnection.prototype.removeTrack = function(sender) {\n      var pc = this;\n      if (pc.signalingState === 'closed') {\n        throw new DOMException(\n          'The RTCPeerConnection\\'s signalingState is \\'closed\\'.',\n          'InvalidStateError');\n      }\n      // We can not yet check for sender instanceof RTCRtpSender\n      // since we shim RTPSender. So we check if sender._pc is set.\n      if (!sender._pc) {\n        throw new DOMException('Argument 1 of RTCPeerConnection.removeTrack ' +\n            'does not implement interface RTCRtpSender.', 'TypeError');\n      }\n      var isLocal = sender._pc === pc;\n      if (!isLocal) {\n        throw new DOMException('Sender was not created by this connection.',\n            'InvalidAccessError');\n      }\n\n      // Search for the native stream the senders track belongs to.\n      pc._streams = pc._streams || {};\n      var stream;\n      Object.keys(pc._streams).forEach(function(streamid) {\n        var hasTrack = pc._streams[streamid].getTracks().find(function(track) {\n          return sender.track === track;\n        });\n        if (hasTrack) {\n          stream = pc._streams[streamid];\n        }\n      });\n\n      if (stream) {\n        if (stream.getTracks().length === 1) {\n          // if this is the last track of the stream, remove the stream. This\n          // takes care of any shimmed _senders.\n          pc.removeStream(pc._reverseStreams[stream.id]);\n        } else {\n          // relying on the same odd chrome behaviour as above.\n          stream.removeTrack(sender.track);\n        }\n        pc.dispatchEvent(new Event('negotiationneeded'));\n      }\n    };\n  },\n\n  shimPeerConnection: function(window) {\n    var browserDetails = utils.detectBrowser(window);\n\n    // The RTCPeerConnection object.\n    if (!window.RTCPeerConnection && window.webkitRTCPeerConnection) {\n      window.RTCPeerConnection = function(pcConfig, pcConstraints) {\n        // Translate iceTransportPolicy to iceTransports,\n        // see https://code.google.com/p/webrtc/issues/detail?id=4869\n        // this was fixed in M56 along with unprefixing RTCPeerConnection.\n        logging('PeerConnection');\n        if (pcConfig && pcConfig.iceTransportPolicy) {\n          pcConfig.iceTransports = pcConfig.iceTransportPolicy;\n        }\n\n        return new window.webkitRTCPeerConnection(pcConfig, pcConstraints);\n      };\n      window.RTCPeerConnection.prototype =\n          window.webkitRTCPeerConnection.prototype;\n      // wrap static methods. Currently just generateCertificate.\n      if (window.webkitRTCPeerConnection.generateCertificate) {\n        Object.defineProperty(window.RTCPeerConnection, 'generateCertificate', {\n          get: function() {\n            return window.webkitRTCPeerConnection.generateCertificate;\n          }\n        });\n      }\n    }\n    if (!window.RTCPeerConnection) {\n      return;\n    }\n\n    var origGetStats = window.RTCPeerConnection.prototype.getStats;\n    window.RTCPeerConnection.prototype.getStats = function(selector,\n        successCallback, errorCallback) {\n      var pc = this;\n      var args = arguments;\n\n      // If selector is a function then we are in the old style stats so just\n      // pass back the original getStats format to avoid breaking old users.\n      if (arguments.length > 0 && typeof selector === 'function') {\n        return origGetStats.apply(this, arguments);\n      }\n\n      // When spec-style getStats is supported, return those when called with\n      // either no arguments or the selector argument is null.\n      if (origGetStats.length === 0 && (arguments.length === 0 ||\n          typeof arguments[0] !== 'function')) {\n        return origGetStats.apply(this, []);\n      }\n\n      var fixChromeStats_ = function(response) {\n        var standardReport = {};\n        var reports = response.result();\n        reports.forEach(function(report) {\n          var standardStats = {\n            id: report.id,\n            timestamp: report.timestamp,\n            type: {\n              localcandidate: 'local-candidate',\n              remotecandidate: 'remote-candidate'\n            }[report.type] || report.type\n          };\n          report.names().forEach(function(name) {\n            standardStats[name] = report.stat(name);\n          });\n          standardReport[standardStats.id] = standardStats;\n        });\n\n        return standardReport;\n      };\n\n      // shim getStats with maplike support\n      var makeMapStats = function(stats) {\n        return new Map(Object.keys(stats).map(function(key) {\n          return [key, stats[key]];\n        }));\n      };\n\n      if (arguments.length >= 2) {\n        var successCallbackWrapper_ = function(response) {\n          args[1](makeMapStats(fixChromeStats_(response)));\n        };\n\n        return origGetStats.apply(this, [successCallbackWrapper_,\n          arguments[0]]);\n      }\n\n      // promise-support\n      return new Promise(function(resolve, reject) {\n        origGetStats.apply(pc, [\n          function(response) {\n            resolve(makeMapStats(fixChromeStats_(response)));\n          }, reject]);\n      }).then(successCallback, errorCallback);\n    };\n\n    // add promise support -- natively available in Chrome 51\n    if (browserDetails.version < 51) {\n      ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate']\n          .forEach(function(method) {\n            var nativeMethod = window.RTCPeerConnection.prototype[method];\n            window.RTCPeerConnection.prototype[method] = function() {\n              var args = arguments;\n              var pc = this;\n              var promise = new Promise(function(resolve, reject) {\n                nativeMethod.apply(pc, [args[0], resolve, reject]);\n              });\n              if (args.length < 2) {\n                return promise;\n              }\n              return promise.then(function() {\n                args[1].apply(null, []);\n              },\n              function(err) {\n                if (args.length >= 3) {\n                  args[2].apply(null, [err]);\n                }\n              });\n            };\n          });\n    }\n\n    // promise support for createOffer and createAnswer. Available (without\n    // bugs) since M52: crbug/619289\n    if (browserDetails.version < 52) {\n      ['createOffer', 'createAnswer'].forEach(function(method) {\n        var nativeMethod = window.RTCPeerConnection.prototype[method];\n        window.RTCPeerConnection.prototype[method] = function() {\n          var pc = this;\n          if (arguments.length < 1 || (arguments.length === 1 &&\n              typeof arguments[0] === 'object')) {\n            var opts = arguments.length === 1 ? arguments[0] : undefined;\n            return new Promise(function(resolve, reject) {\n              nativeMethod.apply(pc, [resolve, reject, opts]);\n            });\n          }\n          return nativeMethod.apply(this, arguments);\n        };\n      });\n    }\n\n    // shim implicit creation of RTCSessionDescription/RTCIceCandidate\n    ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate']\n        .forEach(function(method) {\n          var nativeMethod = window.RTCPeerConnection.prototype[method];\n          window.RTCPeerConnection.prototype[method] = function() {\n            arguments[0] = new ((method === 'addIceCandidate') ?\n                window.RTCIceCandidate :\n                window.RTCSessionDescription)(arguments[0]);\n            return nativeMethod.apply(this, arguments);\n          };\n        });\n\n    // support for addIceCandidate(null or undefined)\n    var nativeAddIceCandidate =\n        window.RTCPeerConnection.prototype.addIceCandidate;\n    window.RTCPeerConnection.prototype.addIceCandidate = function() {\n      if (!arguments[0]) {\n        if (arguments[1]) {\n          arguments[1].apply(null);\n        }\n        return Promise.resolve();\n      }\n      return nativeAddIceCandidate.apply(this, arguments);\n    };\n  },\n\n  fixNegotiationNeeded: function(window) {\n    utils.wrapPeerConnectionEvent(window, 'negotiationneeded', function(e) {\n      var pc = e.target;\n      if (pc.signalingState !== 'stable') {\n        return;\n      }\n      return e;\n    });\n  },\n\n  shimGetDisplayMedia: function(window, getSourceId) {\n    if (!window.navigator || !window.navigator.mediaDevices ||\n        'getDisplayMedia' in window.navigator.mediaDevices) {\n      return;\n    }\n    // getSourceId is a function that returns a promise resolving with\n    // the sourceId of the screen/window/tab to be shared.\n    if (typeof getSourceId !== 'function') {\n      console.error('shimGetDisplayMedia: getSourceId argument is not ' +\n          'a function');\n      return;\n    }\n    window.navigator.mediaDevices.getDisplayMedia = function(constraints) {\n      return getSourceId(constraints)\n        .then(function(sourceId) {\n          var widthSpecified = constraints.video && constraints.video.width;\n          var heightSpecified = constraints.video && constraints.video.height;\n          var frameRateSpecified = constraints.video &&\n            constraints.video.frameRate;\n          constraints.video = {\n            mandatory: {\n              chromeMediaSource: 'desktop',\n              chromeMediaSourceId: sourceId,\n              maxFrameRate: frameRateSpecified || 3\n            }\n          };\n          if (widthSpecified) {\n            constraints.video.mandatory.maxWidth = widthSpecified;\n          }\n          if (heightSpecified) {\n            constraints.video.mandatory.maxHeight = heightSpecified;\n          }\n          return window.navigator.mediaDevices.getUserMedia(constraints);\n        });\n    };\n    window.navigator.getDisplayMedia = function(constraints) {\n      utils.deprecated('navigator.getDisplayMedia',\n          'navigator.mediaDevices.getDisplayMedia');\n      return window.navigator.mediaDevices.getDisplayMedia(constraints);\n    };\n  }\n};\n"]},"metadata":{},"sourceType":"script"}