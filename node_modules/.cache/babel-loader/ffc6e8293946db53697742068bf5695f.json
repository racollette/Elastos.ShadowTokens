{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.BitgoUTXOLib = void 0;\n\nconst bitcoin = __importStar(require(\"bitgo-utxo-lib\"));\n\nconst bignumber_js_1 = __importDefault(require(\"bignumber.js\"));\n\nconst buildUTXO = async (network, privateKey, changeAddress, toAddress, valueIn, utxos, options) => {\n  const fees = new bignumber_js_1.default(options && options.fee !== undefined ? options.fee : 10000);\n  const value = options && options.subtractFee ? valueIn.minus(fees) : valueIn;\n\n  if (value.lt(0)) {\n    throw new Error(`Unable to include fee in value, fee exceeds value (${fees.toFixed()} > ${valueIn.toFixed()})`);\n  }\n\n  const tx = new bitcoin.TransactionBuilder(network);\n\n  if (options && options.version) {\n    tx.setVersion(options.version);\n  }\n\n  if (options && options.versionGroupID) {\n    tx.setVersionGroupId(0xf5b9230b);\n  }\n\n  if (options && options.expiryHeight) {\n    tx.setExpiryHeight(options.expiryHeight);\n  }\n\n  if (options && options.lockTime) {\n    tx.setLockTime(options.lockTime);\n  } // Only use the required utxos\n\n\n  const [usedUTXOs, sum] = utxos.reduce(([utxoAcc, total], utxo) => total.lt(value.plus(fees)) ? [[...utxoAcc, utxo], total.plus(utxo.amount)] : [utxoAcc, total], [[], new bignumber_js_1.default(0)]);\n\n  if (sum.lt(value.plus(fees))) {\n    throw new Error(\"Insufficient balance to broadcast transaction\");\n  } // Add all inputs\n\n\n  usedUTXOs.map(utxo => {\n    tx.addInput(utxo.txHash, utxo.vOut);\n  });\n  const change = sum.minus(value).minus(fees); // Add outputs\n\n  tx.addOutput(toAddress, value.toNumber());\n\n  if (change.gt(0)) {\n    tx.addOutput(changeAddress, change.toNumber());\n  } // Sign inputs\n\n\n  usedUTXOs.map((utxo, i) => {\n    tx.sign(i, privateKey, \"\", options && options.signFlag !== undefined ? options.signFlag : null, utxo.amount);\n  });\n  return tx.build();\n};\n\nconst loadPrivateKey = (network, privateKey) => {\n  return bitcoin.ECPair.fromPrivateKeyBuffer(Buffer.from(privateKey, \"hex\"), network);\n};\n\nexports.BitgoUTXOLib = {\n  buildUTXO,\n  loadPrivateKey\n};","map":{"version":3,"sources":["../../../../src/common/libraries/bitgoUtxoLib.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.BitgoUTXOLib = void 0;\nconst bitcoin = __importStar(require(\"bitgo-utxo-lib\"));\nconst bignumber_js_1 = __importDefault(require(\"bignumber.js\"));\nconst buildUTXO = async (network, privateKey, changeAddress, toAddress, valueIn, utxos, options) => {\n    const fees = new bignumber_js_1.default(options && options.fee !== undefined ? options.fee : 10000);\n    const value = options && options.subtractFee ? valueIn.minus(fees) : valueIn;\n    if (value.lt(0)) {\n        throw new Error(`Unable to include fee in value, fee exceeds value (${fees.toFixed()} > ${valueIn.toFixed()})`);\n    }\n    const tx = new bitcoin.TransactionBuilder(network);\n    if (options && options.version) {\n        tx.setVersion(options.version);\n    }\n    if (options && options.versionGroupID) {\n        tx.setVersionGroupId(0xf5b9230b);\n    }\n    if (options && options.expiryHeight) {\n        tx.setExpiryHeight(options.expiryHeight);\n    }\n    if (options && options.lockTime) {\n        tx.setLockTime(options.lockTime);\n    }\n    // Only use the required utxos\n    const [usedUTXOs, sum] = utxos.reduce(([utxoAcc, total], utxo) => total.lt(value.plus(fees)) ? [[...utxoAcc, utxo], total.plus(utxo.amount)] : [utxoAcc, total], [[], new bignumber_js_1.default(0)]);\n    if (sum.lt(value.plus(fees))) {\n        throw new Error(\"Insufficient balance to broadcast transaction\");\n    }\n    // Add all inputs\n    usedUTXOs.map(utxo => {\n        tx.addInput(utxo.txHash, utxo.vOut);\n    });\n    const change = sum.minus(value).minus(fees);\n    // Add outputs\n    tx.addOutput(toAddress, value.toNumber());\n    if (change.gt(0)) {\n        tx.addOutput(changeAddress, change.toNumber());\n    }\n    // Sign inputs\n    usedUTXOs.map((utxo, i) => {\n        tx.sign(i, privateKey, \"\", options && options.signFlag !== undefined ? options.signFlag : null, utxo.amount);\n    });\n    return tx.build();\n};\nconst loadPrivateKey = (network, privateKey) => {\n    return bitcoin.ECPair.fromPrivateKeyBuffer(Buffer.from(privateKey, \"hex\"), network);\n};\nexports.BitgoUTXOLib = {\n    buildUTXO,\n    loadPrivateKey,\n};\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYml0Z29VdHhvTGliLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbW1vbi9saWJyYXJpZXMvYml0Z29VdHhvTGliLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx3REFBMEM7QUFFMUMsZ0VBQXFDO0FBSXJDLE1BQU0sU0FBUyxHQUFHLEtBQUssRUFDbkIsT0FBd0MsRUFDeEMsVUFBZSxFQUFFLGFBQXFCLEVBQUUsU0FBaUIsRUFBRSxPQUFrQixFQUFFLEtBQWEsRUFDNUYsT0FHQyxFQUMrQixFQUFFO0lBQ2xDLE1BQU0sSUFBSSxHQUFHLElBQUksc0JBQVMsQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLEdBQUcsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRXZGLE1BQU0sS0FBSyxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7SUFDN0UsSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ2IsTUFBTSxJQUFJLEtBQUssQ0FBQyxzREFBc0QsSUFBSSxDQUFDLE9BQU8sRUFBRSxNQUFNLE9BQU8sQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7S0FDbkg7SUFFRCxNQUFNLEVBQUUsR0FBRyxJQUFJLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNuRCxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFO1FBQzVCLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQ2xDO0lBQ0QsSUFBSSxPQUFPLElBQUksT0FBTyxDQUFDLGNBQWMsRUFBRTtRQUNu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"]},"metadata":{},"sourceType":"script"}