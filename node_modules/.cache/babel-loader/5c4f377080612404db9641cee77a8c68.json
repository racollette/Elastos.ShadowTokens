{"ast":null,"code":"/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n\n/* eslint-env node */\n'use strict';\n\nvar utils = require('../utils.js');\n\nvar logging = utils.log; // Expose public methods.\n\nmodule.exports = function (window) {\n  var browserDetails = utils.detectBrowser(window);\n  var navigator = window && window.navigator;\n\n  var constraintsToChrome_ = function (c) {\n    if (typeof c !== 'object' || c.mandatory || c.optional) {\n      return c;\n    }\n\n    var cc = {};\n    Object.keys(c).forEach(function (key) {\n      if (key === 'require' || key === 'advanced' || key === 'mediaSource') {\n        return;\n      }\n\n      var r = typeof c[key] === 'object' ? c[key] : {\n        ideal: c[key]\n      };\n\n      if (r.exact !== undefined && typeof r.exact === 'number') {\n        r.min = r.max = r.exact;\n      }\n\n      var oldname_ = function (prefix, name) {\n        if (prefix) {\n          return prefix + name.charAt(0).toUpperCase() + name.slice(1);\n        }\n\n        return name === 'deviceId' ? 'sourceId' : name;\n      };\n\n      if (r.ideal !== undefined) {\n        cc.optional = cc.optional || [];\n        var oc = {};\n\n        if (typeof r.ideal === 'number') {\n          oc[oldname_('min', key)] = r.ideal;\n          cc.optional.push(oc);\n          oc = {};\n          oc[oldname_('max', key)] = r.ideal;\n          cc.optional.push(oc);\n        } else {\n          oc[oldname_('', key)] = r.ideal;\n          cc.optional.push(oc);\n        }\n      }\n\n      if (r.exact !== undefined && typeof r.exact !== 'number') {\n        cc.mandatory = cc.mandatory || {};\n        cc.mandatory[oldname_('', key)] = r.exact;\n      } else {\n        ['min', 'max'].forEach(function (mix) {\n          if (r[mix] !== undefined) {\n            cc.mandatory = cc.mandatory || {};\n            cc.mandatory[oldname_(mix, key)] = r[mix];\n          }\n        });\n      }\n    });\n\n    if (c.advanced) {\n      cc.optional = (cc.optional || []).concat(c.advanced);\n    }\n\n    return cc;\n  };\n\n  var shimConstraints_ = function (constraints, func) {\n    if (browserDetails.version >= 61) {\n      return func(constraints);\n    }\n\n    constraints = JSON.parse(JSON.stringify(constraints));\n\n    if (constraints && typeof constraints.audio === 'object') {\n      var remap = function (obj, a, b) {\n        if (a in obj && !(b in obj)) {\n          obj[b] = obj[a];\n          delete obj[a];\n        }\n      };\n\n      constraints = JSON.parse(JSON.stringify(constraints));\n      remap(constraints.audio, 'autoGainControl', 'googAutoGainControl');\n      remap(constraints.audio, 'noiseSuppression', 'googNoiseSuppression');\n      constraints.audio = constraintsToChrome_(constraints.audio);\n    }\n\n    if (constraints && typeof constraints.video === 'object') {\n      // Shim facingMode for mobile & surface pro.\n      var face = constraints.video.facingMode;\n      face = face && (typeof face === 'object' ? face : {\n        ideal: face\n      });\n      var getSupportedFacingModeLies = browserDetails.version < 66;\n\n      if (face && (face.exact === 'user' || face.exact === 'environment' || face.ideal === 'user' || face.ideal === 'environment') && !(navigator.mediaDevices.getSupportedConstraints && navigator.mediaDevices.getSupportedConstraints().facingMode && !getSupportedFacingModeLies)) {\n        delete constraints.video.facingMode;\n        var matches;\n\n        if (face.exact === 'environment' || face.ideal === 'environment') {\n          matches = ['back', 'rear'];\n        } else if (face.exact === 'user' || face.ideal === 'user') {\n          matches = ['front'];\n        }\n\n        if (matches) {\n          // Look for matches in label, or use last cam for back (typical).\n          return navigator.mediaDevices.enumerateDevices().then(function (devices) {\n            devices = devices.filter(function (d) {\n              return d.kind === 'videoinput';\n            });\n            var dev = devices.find(function (d) {\n              return matches.some(function (match) {\n                return d.label.toLowerCase().indexOf(match) !== -1;\n              });\n            });\n\n            if (!dev && devices.length && matches.indexOf('back') !== -1) {\n              dev = devices[devices.length - 1]; // more likely the back cam\n            }\n\n            if (dev) {\n              constraints.video.deviceId = face.exact ? {\n                exact: dev.deviceId\n              } : {\n                ideal: dev.deviceId\n              };\n            }\n\n            constraints.video = constraintsToChrome_(constraints.video);\n            logging('chrome: ' + JSON.stringify(constraints));\n            return func(constraints);\n          });\n        }\n      }\n\n      constraints.video = constraintsToChrome_(constraints.video);\n    }\n\n    logging('chrome: ' + JSON.stringify(constraints));\n    return func(constraints);\n  };\n\n  var shimError_ = function (e) {\n    if (browserDetails.version >= 64) {\n      return e;\n    }\n\n    return {\n      name: {\n        PermissionDeniedError: 'NotAllowedError',\n        PermissionDismissedError: 'NotAllowedError',\n        InvalidStateError: 'NotAllowedError',\n        DevicesNotFoundError: 'NotFoundError',\n        ConstraintNotSatisfiedError: 'OverconstrainedError',\n        TrackStartError: 'NotReadableError',\n        MediaDeviceFailedDueToShutdown: 'NotAllowedError',\n        MediaDeviceKillSwitchOn: 'NotAllowedError',\n        TabCaptureError: 'AbortError',\n        ScreenCaptureError: 'AbortError',\n        DeviceCaptureError: 'AbortError'\n      }[e.name] || e.name,\n      message: e.message,\n      constraint: e.constraint || e.constraintName,\n      toString: function () {\n        return this.name + (this.message && ': ') + this.message;\n      }\n    };\n  };\n\n  var getUserMedia_ = function (constraints, onSuccess, onError) {\n    shimConstraints_(constraints, function (c) {\n      navigator.webkitGetUserMedia(c, onSuccess, function (e) {\n        if (onError) {\n          onError(shimError_(e));\n        }\n      });\n    });\n  };\n\n  navigator.getUserMedia = getUserMedia_; // Returns the result of getUserMedia as a Promise.\n\n  var getUserMediaPromise_ = function (constraints) {\n    return new Promise(function (resolve, reject) {\n      navigator.getUserMedia(constraints, resolve, reject);\n    });\n  };\n\n  if (!navigator.mediaDevices) {\n    navigator.mediaDevices = {\n      getUserMedia: getUserMediaPromise_,\n      enumerateDevices: function () {\n        return new Promise(function (resolve) {\n          var kinds = {\n            audio: 'audioinput',\n            video: 'videoinput'\n          };\n          return window.MediaStreamTrack.getSources(function (devices) {\n            resolve(devices.map(function (device) {\n              return {\n                label: device.label,\n                kind: kinds[device.kind],\n                deviceId: device.id,\n                groupId: ''\n              };\n            }));\n          });\n        });\n      },\n      getSupportedConstraints: function () {\n        return {\n          deviceId: true,\n          echoCancellation: true,\n          facingMode: true,\n          frameRate: true,\n          height: true,\n          width: true\n        };\n      }\n    };\n  } // A shim for getUserMedia method on the mediaDevices object.\n  // TODO(KaptenJansson) remove once implemented in Chrome stable.\n\n\n  if (!navigator.mediaDevices.getUserMedia) {\n    navigator.mediaDevices.getUserMedia = function (constraints) {\n      return getUserMediaPromise_(constraints);\n    };\n  } else {\n    // Even though Chrome 45 has navigator.mediaDevices and a getUserMedia\n    // function which returns a Promise, it does not accept spec-style\n    // constraints.\n    var origGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);\n\n    navigator.mediaDevices.getUserMedia = function (cs) {\n      return shimConstraints_(cs, function (c) {\n        return origGetUserMedia(c).then(function (stream) {\n          if (c.audio && !stream.getAudioTracks().length || c.video && !stream.getVideoTracks().length) {\n            stream.getTracks().forEach(function (track) {\n              track.stop();\n            });\n            throw new DOMException('', 'NotFoundError');\n          }\n\n          return stream;\n        }, function (e) {\n          return Promise.reject(shimError_(e));\n        });\n      });\n    };\n  } // Dummy devicechange event methods.\n  // TODO(KaptenJansson) remove once implemented in Chrome stable.\n\n\n  if (typeof navigator.mediaDevices.addEventListener === 'undefined') {\n    navigator.mediaDevices.addEventListener = function () {\n      logging('Dummy mediaDevices.addEventListener called.');\n    };\n  }\n\n  if (typeof navigator.mediaDevices.removeEventListener === 'undefined') {\n    navigator.mediaDevices.removeEventListener = function () {\n      logging('Dummy mediaDevices.removeEventListener called.');\n    };\n  }\n};","map":{"version":3,"sources":["/home/ryan/dev/defi/shadowtoken2/node_modules/@myetherwallet/mewconnect-web-client/node_modules/webrtc-adapter/src/js/chrome/getusermedia.js"],"names":["utils","require","logging","log","module","exports","window","browserDetails","detectBrowser","navigator","constraintsToChrome_","c","mandatory","optional","cc","Object","keys","forEach","key","r","ideal","exact","undefined","min","max","oldname_","prefix","name","charAt","toUpperCase","slice","oc","push","mix","advanced","concat","shimConstraints_","constraints","func","version","JSON","parse","stringify","audio","remap","obj","a","b","video","face","facingMode","getSupportedFacingModeLies","mediaDevices","getSupportedConstraints","matches","enumerateDevices","then","devices","filter","d","kind","dev","find","some","match","label","toLowerCase","indexOf","length","deviceId","shimError_","e","PermissionDeniedError","PermissionDismissedError","InvalidStateError","DevicesNotFoundError","ConstraintNotSatisfiedError","TrackStartError","MediaDeviceFailedDueToShutdown","MediaDeviceKillSwitchOn","TabCaptureError","ScreenCaptureError","DeviceCaptureError","message","constraint","constraintName","toString","getUserMedia_","onSuccess","onError","webkitGetUserMedia","getUserMedia","getUserMediaPromise_","Promise","resolve","reject","kinds","MediaStreamTrack","getSources","map","device","id","groupId","echoCancellation","frameRate","height","width","origGetUserMedia","bind","cs","stream","getAudioTracks","getVideoTracks","getTracks","track","stop","DOMException","addEventListener","removeEventListener"],"mappings":"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","sourcesContent":["/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n /* eslint-env node */\n'use strict';\nvar utils = require('../utils.js');\nvar logging = utils.log;\n\n// Expose public methods.\nmodule.exports = function(window) {\n  var browserDetails = utils.detectBrowser(window);\n  var navigator = window && window.navigator;\n\n  var constraintsToChrome_ = function(c) {\n    if (typeof c !== 'object' || c.mandatory || c.optional) {\n      return c;\n    }\n    var cc = {};\n    Object.keys(c).forEach(function(key) {\n      if (key === 'require' || key === 'advanced' || key === 'mediaSource') {\n        return;\n      }\n      var r = (typeof c[key] === 'object') ? c[key] : {ideal: c[key]};\n      if (r.exact !== undefined && typeof r.exact === 'number') {\n        r.min = r.max = r.exact;\n      }\n      var oldname_ = function(prefix, name) {\n        if (prefix) {\n          return prefix + name.charAt(0).toUpperCase() + name.slice(1);\n        }\n        return (name === 'deviceId') ? 'sourceId' : name;\n      };\n      if (r.ideal !== undefined) {\n        cc.optional = cc.optional || [];\n        var oc = {};\n        if (typeof r.ideal === 'number') {\n          oc[oldname_('min', key)] = r.ideal;\n          cc.optional.push(oc);\n          oc = {};\n          oc[oldname_('max', key)] = r.ideal;\n          cc.optional.push(oc);\n        } else {\n          oc[oldname_('', key)] = r.ideal;\n          cc.optional.push(oc);\n        }\n      }\n      if (r.exact !== undefined && typeof r.exact !== 'number') {\n        cc.mandatory = cc.mandatory || {};\n        cc.mandatory[oldname_('', key)] = r.exact;\n      } else {\n        ['min', 'max'].forEach(function(mix) {\n          if (r[mix] !== undefined) {\n            cc.mandatory = cc.mandatory || {};\n            cc.mandatory[oldname_(mix, key)] = r[mix];\n          }\n        });\n      }\n    });\n    if (c.advanced) {\n      cc.optional = (cc.optional || []).concat(c.advanced);\n    }\n    return cc;\n  };\n\n  var shimConstraints_ = function(constraints, func) {\n    if (browserDetails.version >= 61) {\n      return func(constraints);\n    }\n    constraints = JSON.parse(JSON.stringify(constraints));\n    if (constraints && typeof constraints.audio === 'object') {\n      var remap = function(obj, a, b) {\n        if (a in obj && !(b in obj)) {\n          obj[b] = obj[a];\n          delete obj[a];\n        }\n      };\n      constraints = JSON.parse(JSON.stringify(constraints));\n      remap(constraints.audio, 'autoGainControl', 'googAutoGainControl');\n      remap(constraints.audio, 'noiseSuppression', 'googNoiseSuppression');\n      constraints.audio = constraintsToChrome_(constraints.audio);\n    }\n    if (constraints && typeof constraints.video === 'object') {\n      // Shim facingMode for mobile & surface pro.\n      var face = constraints.video.facingMode;\n      face = face && ((typeof face === 'object') ? face : {ideal: face});\n      var getSupportedFacingModeLies = browserDetails.version < 66;\n\n      if ((face && (face.exact === 'user' || face.exact === 'environment' ||\n                    face.ideal === 'user' || face.ideal === 'environment')) &&\n          !(navigator.mediaDevices.getSupportedConstraints &&\n            navigator.mediaDevices.getSupportedConstraints().facingMode &&\n            !getSupportedFacingModeLies)) {\n        delete constraints.video.facingMode;\n        var matches;\n        if (face.exact === 'environment' || face.ideal === 'environment') {\n          matches = ['back', 'rear'];\n        } else if (face.exact === 'user' || face.ideal === 'user') {\n          matches = ['front'];\n        }\n        if (matches) {\n          // Look for matches in label, or use last cam for back (typical).\n          return navigator.mediaDevices.enumerateDevices()\n          .then(function(devices) {\n            devices = devices.filter(function(d) {\n              return d.kind === 'videoinput';\n            });\n            var dev = devices.find(function(d) {\n              return matches.some(function(match) {\n                return d.label.toLowerCase().indexOf(match) !== -1;\n              });\n            });\n            if (!dev && devices.length && matches.indexOf('back') !== -1) {\n              dev = devices[devices.length - 1]; // more likely the back cam\n            }\n            if (dev) {\n              constraints.video.deviceId = face.exact ? {exact: dev.deviceId} :\n                                                        {ideal: dev.deviceId};\n            }\n            constraints.video = constraintsToChrome_(constraints.video);\n            logging('chrome: ' + JSON.stringify(constraints));\n            return func(constraints);\n          });\n        }\n      }\n      constraints.video = constraintsToChrome_(constraints.video);\n    }\n    logging('chrome: ' + JSON.stringify(constraints));\n    return func(constraints);\n  };\n\n  var shimError_ = function(e) {\n    if (browserDetails.version >= 64) {\n      return e;\n    }\n    return {\n      name: {\n        PermissionDeniedError: 'NotAllowedError',\n        PermissionDismissedError: 'NotAllowedError',\n        InvalidStateError: 'NotAllowedError',\n        DevicesNotFoundError: 'NotFoundError',\n        ConstraintNotSatisfiedError: 'OverconstrainedError',\n        TrackStartError: 'NotReadableError',\n        MediaDeviceFailedDueToShutdown: 'NotAllowedError',\n        MediaDeviceKillSwitchOn: 'NotAllowedError',\n        TabCaptureError: 'AbortError',\n        ScreenCaptureError: 'AbortError',\n        DeviceCaptureError: 'AbortError'\n      }[e.name] || e.name,\n      message: e.message,\n      constraint: e.constraint || e.constraintName,\n      toString: function() {\n        return this.name + (this.message && ': ') + this.message;\n      }\n    };\n  };\n\n  var getUserMedia_ = function(constraints, onSuccess, onError) {\n    shimConstraints_(constraints, function(c) {\n      navigator.webkitGetUserMedia(c, onSuccess, function(e) {\n        if (onError) {\n          onError(shimError_(e));\n        }\n      });\n    });\n  };\n\n  navigator.getUserMedia = getUserMedia_;\n\n  // Returns the result of getUserMedia as a Promise.\n  var getUserMediaPromise_ = function(constraints) {\n    return new Promise(function(resolve, reject) {\n      navigator.getUserMedia(constraints, resolve, reject);\n    });\n  };\n\n  if (!navigator.mediaDevices) {\n    navigator.mediaDevices = {\n      getUserMedia: getUserMediaPromise_,\n      enumerateDevices: function() {\n        return new Promise(function(resolve) {\n          var kinds = {audio: 'audioinput', video: 'videoinput'};\n          return window.MediaStreamTrack.getSources(function(devices) {\n            resolve(devices.map(function(device) {\n              return {label: device.label,\n                kind: kinds[device.kind],\n                deviceId: device.id,\n                groupId: ''};\n            }));\n          });\n        });\n      },\n      getSupportedConstraints: function() {\n        return {\n          deviceId: true, echoCancellation: true, facingMode: true,\n          frameRate: true, height: true, width: true\n        };\n      }\n    };\n  }\n\n  // A shim for getUserMedia method on the mediaDevices object.\n  // TODO(KaptenJansson) remove once implemented in Chrome stable.\n  if (!navigator.mediaDevices.getUserMedia) {\n    navigator.mediaDevices.getUserMedia = function(constraints) {\n      return getUserMediaPromise_(constraints);\n    };\n  } else {\n    // Even though Chrome 45 has navigator.mediaDevices and a getUserMedia\n    // function which returns a Promise, it does not accept spec-style\n    // constraints.\n    var origGetUserMedia = navigator.mediaDevices.getUserMedia.\n        bind(navigator.mediaDevices);\n    navigator.mediaDevices.getUserMedia = function(cs) {\n      return shimConstraints_(cs, function(c) {\n        return origGetUserMedia(c).then(function(stream) {\n          if (c.audio && !stream.getAudioTracks().length ||\n              c.video && !stream.getVideoTracks().length) {\n            stream.getTracks().forEach(function(track) {\n              track.stop();\n            });\n            throw new DOMException('', 'NotFoundError');\n          }\n          return stream;\n        }, function(e) {\n          return Promise.reject(shimError_(e));\n        });\n      });\n    };\n  }\n\n  // Dummy devicechange event methods.\n  // TODO(KaptenJansson) remove once implemented in Chrome stable.\n  if (typeof navigator.mediaDevices.addEventListener === 'undefined') {\n    navigator.mediaDevices.addEventListener = function() {\n      logging('Dummy mediaDevices.addEventListener called.');\n    };\n  }\n  if (typeof navigator.mediaDevices.removeEventListener === 'undefined') {\n    navigator.mediaDevices.removeEventListener = function() {\n      logging('Dummy mediaDevices.removeEventListener called.');\n    };\n  }\n};\n"]},"metadata":{},"sourceType":"script"}